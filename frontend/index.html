<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA V3 - Hybrid AI DAW Mockup</title>
    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Background Colors - BRIGHTER */
            --bg-main: #252530;
            --bg-gap: #020202;
            --bg-panel: #3A3D45;
            --bg-input: #32353D;
            --bg-transport: #2A2A35;

            /* Chat Colors */
            --chat-user: #2A3547;
            --chat-ai: #263D30;

            /* Track Colors - Dark backgrounds with neon borders */
            --chord-bg: #1E3A5F;
            --chord-border: #4A90D9;
            --drums-bg: #4A2020;
            --drums-border: #E85D4E;
            --bass-bg: #1E3D2F;
            --bass-border: #4FD272;
            --piano-bg: #1E3A4A;
            --piano-border: #5DADE2;
            --vocal-bg: #3D2050;
            --vocal-border: #9D65D8;

            /* Legacy - keep for compatibility */
            --chord-region: #314963;
            --track-chord: #314963;
            --track-drums: #E85D4E;
            --track-bass: #4FD272;
            --track-piano: #5DADE2;
            --track-vocal: #9D65D8;

            /* Button Colors */
            --rec-bg: #9B4342;
            --rec-circle: #F95F5B;
            --neon-cyan: #4DFFFF;
            --neon-purple: #D45FFF;

            /* Text Colors */
            --text-main: #C0C6C5;
            --text-muted: #808590;

            /* Layout */
            --corner-radius: 6px;
            --corner-radius-lg: 8px;
            --panel-gap: 6px;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-gap);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout */
        .app-container {
            display: grid;
            grid-template-rows: 60px 1fr;
            grid-template-columns: 280px 1fr 300px;
            height: 100vh;
            gap: var(--panel-gap);
            padding: var(--panel-gap);
        }

        /* Header - spans full width */
        .header {
            grid-column: 1 / -1;
            background-color: var(--bg-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-radius: var(--corner-radius-lg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .project-name {
            font-size: 16px;
            color: var(--text-main);
        }

        .undo-redo-group {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .undo-redo-btn {
            background: transparent;
            border: none;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .undo-redo-btn svg {
            width: 20px;
            height: 20px;
            stroke: #888888;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.15s ease;
        }

        .undo-redo-btn:hover svg {
            stroke: #CCCCCC;
        }

        .header-btn {
            background: var(--bg-panel);
            border: none;
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            font-size: 12px;
        }

        .header-btn:hover {
            opacity: 0.8;
        }

        /* Transport Controls - Grouped in Box */
        .header-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .transport-group {
            display: flex;
            align-items: center;
            background: #0A0A0C;
            border-radius: 10px;
            padding: 6px;
            gap: 6px;
        }

        .transport-btn {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            outline: none;
        }

        .transport-btn:focus {
            outline: none;
        }

        .rec-btn:focus {
            outline: none;
        }

        /* Play Button - Green Neon (#4FD272) */
        .play-btn {
            background: rgba(79, 210, 114, 0.08);
            border: 1px solid rgba(79, 210, 114, 0.3);
            box-shadow: 0 0 6px rgba(79, 210, 114, 0.2),
                        inset 0 0 8px rgba(79, 210, 114, 0.05);
        }

        .play-btn:hover {
            background: rgba(79, 210, 114, 0.15);
            border-color: rgba(79, 210, 114, 0.5);
            box-shadow: 0 0 12px rgba(79, 210, 114, 0.4),
                        0 0 25px rgba(79, 210, 114, 0.2),
                        inset 0 0 15px rgba(79, 210, 114, 0.1);
        }

        .play-btn:active {
            background: rgba(79, 210, 114, 0.25);
            border-color: rgba(79, 210, 114, 0.7);
            box-shadow: 0 0 20px rgba(79, 210, 114, 0.6),
                        0 0 40px rgba(79, 210, 114, 0.3),
                        0 0 60px rgba(79, 210, 114, 0.15),
                        inset 0 0 20px rgba(79, 210, 114, 0.15);
            transform: scale(0.95);
        }

        .play-icon {
            width: 0;
            height: 0;
            border-left: 14px solid #4FD272;
            border-top: 9px solid transparent;
            border-bottom: 9px solid transparent;
            margin-left: 4px;
            filter: drop-shadow(0 0 4px rgba(79, 210, 114, 0.6));
            transition: all 0.15s ease;
        }

        .play-btn:hover .play-icon {
            filter: drop-shadow(0 0 8px rgba(79, 210, 114, 0.8));
        }

        .play-btn:active .play-icon {
            border-left-color: #80FF99;
            filter: drop-shadow(0 0 12px rgba(79, 210, 114, 1));
        }

        /* Play Button - Playing State (Neon Glow ON) */
        .play-btn.playing {
            background: rgba(79, 210, 114, 0.25);
            border-color: rgba(79, 210, 114, 0.8);
            box-shadow: 0 0 15px rgba(79, 210, 114, 0.6),
                        0 0 30px rgba(79, 210, 114, 0.4),
                        0 0 50px rgba(79, 210, 114, 0.2),
                        inset 0 0 15px rgba(79, 210, 114, 0.15);
            animation: playGlow 1.5s ease-in-out infinite;
        }

        .play-btn.playing .play-icon {
            border-left-color: #80FF99;
            filter: drop-shadow(0 0 10px rgba(79, 210, 114, 1));
        }

        @keyframes playGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(79, 210, 114, 0.6),
                            0 0 30px rgba(79, 210, 114, 0.4),
                            0 0 50px rgba(79, 210, 114, 0.2),
                            inset 0 0 15px rgba(79, 210, 114, 0.15);
            }
            50% {
                box-shadow: 0 0 20px rgba(79, 210, 114, 0.8),
                            0 0 40px rgba(79, 210, 114, 0.5),
                            0 0 60px rgba(79, 210, 114, 0.3),
                            inset 0 0 20px rgba(79, 210, 114, 0.2);
            }
        }

        /* Stop Button - Yellow Neon (#FFD84D) */
        .stop-btn {
            background: rgba(255, 216, 77, 0.08);
            border: 1px solid rgba(255, 216, 77, 0.3);
            box-shadow: 0 0 6px rgba(255, 216, 77, 0.2),
                        inset 0 0 8px rgba(255, 216, 77, 0.05);
        }

        .stop-btn:hover {
            background: rgba(255, 216, 77, 0.15);
            border-color: rgba(255, 216, 77, 0.5);
            box-shadow: 0 0 12px rgba(255, 216, 77, 0.4),
                        0 0 25px rgba(255, 216, 77, 0.2),
                        inset 0 0 15px rgba(255, 216, 77, 0.1);
        }

        .stop-btn:active,
        .stop-btn.pressed {
            background: rgba(255, 216, 77, 0.25);
            border-color: rgba(255, 216, 77, 0.7);
            box-shadow: 0 0 20px rgba(255, 216, 77, 0.6),
                        0 0 40px rgba(255, 216, 77, 0.3),
                        0 0 60px rgba(255, 216, 77, 0.15),
                        inset 0 0 20px rgba(255, 216, 77, 0.15);
            transform: scale(0.95);
        }

        .stop-icon {
            width: 14px;
            height: 14px;
            background: #FFD84D;
            border-radius: 2px;
            box-shadow: 0 0 4px rgba(255, 216, 77, 0.6);
            transition: all 0.15s ease;
        }

        .stop-btn:hover .stop-icon {
            box-shadow: 0 0 8px rgba(255, 216, 77, 0.8);
        }

        .stop-btn:active .stop-icon {
            background: #FFEB80;
            box-shadow: 0 0 12px rgba(255, 216, 77, 1);
        }

        .rec-btn {
            background: rgba(249, 95, 91, 0.08);
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(249, 95, 91, 0.3);
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(249, 95, 91, 0.2),
                        inset 0 0 10px rgba(249, 95, 91, 0.05);
            transition: all 0.15s ease;
        }

        .rec-btn:hover {
            background: rgba(249, 95, 91, 0.15);
            border-color: rgba(249, 95, 91, 0.5);
            box-shadow: 0 0 12px rgba(249, 95, 91, 0.4),
                        0 0 25px rgba(249, 95, 91, 0.2),
                        inset 0 0 15px rgba(249, 95, 91, 0.1);
        }

        .rec-btn:active {
            background: rgba(249, 95, 91, 0.25);
            border-color: rgba(249, 95, 91, 0.7);
            box-shadow: 0 0 20px rgba(249, 95, 91, 0.6),
                        0 0 40px rgba(249, 95, 91, 0.3),
                        0 0 60px rgba(249, 95, 91, 0.15),
                        inset 0 0 20px rgba(249, 95, 91, 0.15);
            transform: scale(0.95);
        }

        .rec-btn .circle {
            width: 20px;
            height: 20px;
            background: var(--rec-circle);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(249, 95, 91, 0.6),
                        0 0 15px rgba(249, 95, 91, 0.3);
            transition: box-shadow 0.15s ease;
        }

        .rec-btn:hover .circle {
            box-shadow: 0 0 12px rgba(249, 95, 91, 0.8),
                        0 0 25px rgba(249, 95, 91, 0.5);
        }

        .rec-btn:active .circle {
            box-shadow: 0 0 18px rgba(249, 95, 91, 1),
                        0 0 35px rgba(249, 95, 91, 0.7),
                        0 0 50px rgba(249, 95, 91, 0.4);
        }

        /* Record Button - Recording State (ON) */
        .rec-btn.recording {
            background: rgba(249, 95, 91, 0.3);
            border-color: rgba(249, 95, 91, 0.9);
            box-shadow: 0 0 20px rgba(249, 95, 91, 0.7),
                        0 0 40px rgba(249, 95, 91, 0.4),
                        0 0 60px rgba(249, 95, 91, 0.2),
                        inset 0 0 15px rgba(249, 95, 91, 0.2);
            animation: recPulse 1s ease-in-out infinite;
        }

        .rec-btn.recording .circle {
            background: #FF6B6B;
            box-shadow: 0 0 15px rgba(249, 95, 91, 1),
                        0 0 30px rgba(249, 95, 91, 0.7),
                        0 0 45px rgba(249, 95, 91, 0.4);
            animation: recCirclePulse 1s ease-in-out infinite;
        }

        @keyframes recPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(249, 95, 91, 0.7),
                            0 0 40px rgba(249, 95, 91, 0.4),
                            0 0 60px rgba(249, 95, 91, 0.2),
                            inset 0 0 15px rgba(249, 95, 91, 0.2);
            }
            50% {
                box-shadow: 0 0 25px rgba(249, 95, 91, 0.9),
                            0 0 50px rgba(249, 95, 91, 0.5),
                            0 0 70px rgba(249, 95, 91, 0.3),
                            inset 0 0 20px rgba(249, 95, 91, 0.25);
            }
        }

        @keyframes recCirclePulse {
            0%, 100% {
                box-shadow: 0 0 15px rgba(249, 95, 91, 1),
                            0 0 30px rgba(249, 95, 91, 0.7),
                            0 0 45px rgba(249, 95, 91, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px rgba(249, 95, 91, 1),
                            0 0 40px rgba(249, 95, 91, 0.8),
                            0 0 55px rgba(249, 95, 91, 0.5);
                transform: scale(1.05);
            }
        }

        .transport-divider {
            width: 1px;
            height: 36px;
            background: #303035;
            margin: 0 8px;
        }

        .tempo-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0 12px 0 6px;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .bpm-value {
            color: var(--text-main);
            font-size: 18px;
            font-weight: 500;
            line-height: 1.2;
            cursor: default;
            min-width: 75px;
        }

        .bpm-value:hover {
            color: #00FFFF;
        }

        .bpm-input {
            width: 80px;
            background: #1A1A20;
            border: 1px solid #00FFFF;
            border-radius: 3px;
            color: #00FFFF;
            font-size: 18px;
            font-weight: 500;
            padding: 4px 6px;
            text-align: left;
            outline: none;
            box-shadow: 0 0 6px rgba(0, 255, 255, 0.3);
            font-family: inherit;
        }

        .bpm-input:focus {
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        /* 숫자 input 스피너 숨기기 */
        .bpm-input::-webkit-outer-spin-button,
        .bpm-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .bpm-input[type=number] {
            -moz-appearance: textfield;
        }

        .bpm-arrows {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .bpm-arrow {
            width: 14px;
            height: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            padding: 0;
            color: #606570;
            transition: all 0.1s ease;
            outline: none;
        }

        .bpm-arrow:hover {
            background: rgba(0, 255, 255, 0.15);
            color: #00FFFF;
        }

        .bpm-arrow:active {
            background: rgba(0, 255, 255, 0.3);
            color: #00FFFF;
        }

        .bpm-arrow svg {
            width: 8px;
            height: 5px;
        }

        .key-display {
            color: #606570;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Metronome Button - 박스 없이 아이콘만 */
        .metronome-btn {
            width: 44px;
            height: 44px;
            background: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            position: relative;
        }

        .metronome-btn:hover {
            background: transparent;
            border: none;
            outline: none;
        }

        .metronome-btn:focus {
            outline: none;
            border: none;
        }

        .metronome-btn:focus-visible {
            outline: none;
        }

        .metronome-btn.active {
            background: transparent;
        }

        .metronome-icon {
            width: 26px;
            height: 26px;
            position: relative;
        }

        .metronome-icon svg {
            width: 100%;
            height: 100%;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metronome-icon .metro-body {
            fill: rgba(80, 80, 100, 0.3);
            stroke: #606070;
            stroke-width: 1.2;
            transition: all 0.2s ease;
        }

        .metronome-icon .metro-pendulum {
            stroke: #808090;
            stroke-width: 1.5;
            stroke-linecap: round;
            transition: all 0.2s ease;
        }

        .metronome-icon .metro-weight {
            fill: #808090;
            transition: all 0.2s ease;
        }

        .metronome-icon .metro-tick {
            fill: #606070;
            transition: all 0.2s ease;
        }

        /* Hover State */
        .metronome-btn:hover .metro-body {
            fill: rgba(0, 255, 255, 0.08);
            stroke: rgba(0, 255, 255, 0.6);
        }

        .metronome-btn:hover .metro-pendulum {
            stroke: rgba(0, 255, 255, 0.8);
        }

        .metronome-btn:hover .metro-weight {
            fill: rgba(0, 255, 255, 0.9);
        }

        /* Active State - 네온 글로우 */
        .metronome-btn.active .metro-body {
            fill: rgba(0, 255, 255, 0.12);
            stroke: var(--neon-cyan);
            filter: drop-shadow(0 0 3px rgba(0, 255, 255, 0.4));
        }

        .metronome-btn.active .metro-pendulum {
            stroke: var(--neon-cyan);
            filter: drop-shadow(0 0 4px rgba(0, 255, 255, 0.8));
        }

        .metronome-btn.active .metro-weight {
            fill: var(--neon-cyan);
            filter: drop-shadow(0 0 6px rgba(0, 255, 255, 1));
        }

        .metronome-btn.active .metro-tick {
            fill: rgba(0, 255, 255, 0.5);
        }

        /* Pendulum swing - JS로 동적 제어 */
        .metro-pendulum-group {
            transform-origin: 12px 18px;
            transition: transform 0.08s ease-out;
        }

        /* Header Right */
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .magic-mix-btn {
            background: rgba(77, 255, 255, 0.05);
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 10px 20px;
            border-radius: var(--corner-radius-lg);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(77, 255, 255, 0.8);
            box-shadow: 0 0 8px rgba(77, 255, 255, 0.4),
                        0 0 20px rgba(77, 255, 255, 0.2),
                        0 0 40px rgba(77, 255, 255, 0.1),
                        inset 0 0 15px rgba(77, 255, 255, 0.05);
            transition: all 0.15s ease;
        }

        .magic-mix-btn:hover {
            background: rgba(77, 255, 255, 0.1);
            text-shadow: 0 0 15px rgba(77, 255, 255, 1);
            box-shadow: 0 0 12px rgba(77, 255, 255, 0.6),
                        0 0 30px rgba(77, 255, 255, 0.4),
                        0 0 60px rgba(77, 255, 255, 0.2),
                        inset 0 0 20px rgba(77, 255, 255, 0.1);
        }

        .magic-mix-btn:active {
            background: rgba(77, 255, 255, 0.25);
            border-color: #80FFFF;
            color: #FFFFFF;
            text-shadow: 0 0 20px rgba(77, 255, 255, 1),
                         0 0 40px rgba(77, 255, 255, 0.8);
            box-shadow: 0 0 20px rgba(77, 255, 255, 0.8),
                        0 0 40px rgba(77, 255, 255, 0.5),
                        0 0 80px rgba(77, 255, 255, 0.3),
                        inset 0 0 30px rgba(77, 255, 255, 0.2);
            transform: scale(0.98);
        }

        .export-btn {
            background: rgba(212, 95, 255, 0.05);
            border: 2px solid var(--neon-purple);
            color: var(--neon-purple);
            padding: 10px 20px;
            border-radius: var(--corner-radius-lg);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(212, 95, 255, 0.8);
            box-shadow: 0 0 8px rgba(212, 95, 255, 0.4),
                        0 0 20px rgba(212, 95, 255, 0.2),
                        0 0 40px rgba(212, 95, 255, 0.1),
                        inset 0 0 15px rgba(212, 95, 255, 0.05);
            transition: all 0.15s ease;
        }

        .export-btn:hover {
            background: rgba(212, 95, 255, 0.1);
            text-shadow: 0 0 15px rgba(212, 95, 255, 1);
            box-shadow: 0 0 12px rgba(212, 95, 255, 0.6),
                        0 0 30px rgba(212, 95, 255, 0.4),
                        0 0 60px rgba(212, 95, 255, 0.2),
                        inset 0 0 20px rgba(212, 95, 255, 0.1);
        }

        .export-btn:active {
            background: rgba(212, 95, 255, 0.25);
            border-color: #E080FF;
            color: #FFFFFF;
            text-shadow: 0 0 20px rgba(212, 95, 255, 1),
                         0 0 40px rgba(212, 95, 255, 0.8);
            box-shadow: 0 0 20px rgba(212, 95, 255, 0.8),
                        0 0 40px rgba(212, 95, 255, 0.5),
                        0 0 80px rgba(212, 95, 255, 0.3),
                        inset 0 0 30px rgba(212, 95, 255, 0.2);
            transform: scale(0.98);
        }

        /* Icon Buttons */
        .icon-btn {
            background: var(--bg-panel);
            border: none;
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .icon-btn:hover {
            background: var(--bg-input);
        }

        /* Mixer Icon - 4 vertical bars */
        .mixer-icon {
            display: flex;
            gap: 3px;
            align-items: flex-end;
            height: 18px;
        }

        .mixer-bar {
            width: 3px;
            background: var(--text-main);
            border-radius: 1px;
        }

        .mixer-bar:nth-child(1) { height: 12px; }
        .mixer-bar:nth-child(2) { height: 18px; }
        .mixer-bar:nth-child(3) { height: 10px; }
        .mixer-bar:nth-child(4) { height: 15px; }

        /* Project Meta Icon - LP disc */
        .disc-icon {
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-main);
            border-radius: 50%;
            position: relative;
        }

        .disc-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: var(--text-main);
            border-radius: 50%;
        }

        /* Resource Browser (Left Sidebar) */
        .resource-browser {
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: var(--corner-radius-lg);
        }

        .sidebar-section {
            padding: 0 15px 15px 15px;
        }

        /* Engraved Panel Title Style - Clear & Readable */
        .section-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            color: #5A5D65;
            text-shadow:
                0 1px 0 rgba(200, 205, 215, 0.5),
                0 -1px 0 rgba(0, 0, 0, 0.7);
            margin-bottom: 10px;
            text-align: center;
            padding: 6px 0;
            border-bottom: 1px solid #2A2D33;
        }

        .ai-generate-box {
            background: var(--bg-panel);
            border-radius: var(--corner-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .ai-generate-box .desc {
            color: var(--text-muted);
            font-size: 12px;
            margin-bottom: 10px;
        }

        .prompt-input {
            background: var(--bg-input);
            border: 1px solid var(--bg-panel);
            border-radius: var(--corner-radius);
            color: var(--text-main);
            padding: 10px;
            width: 100%;
            height: 60px;
            resize: none;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .generate-btn {
            background: rgba(77, 255, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 8px 16px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            font-size: 12px;
            float: right;
        }

        .menu-item {
            background: var(--bg-input);
            border-radius: var(--corner-radius);
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .menu-item:hover {
            background: var(--bg-panel);
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-rows: 1fr 380px;
            gap: var(--panel-gap);
        }

        /* Timeline */
        .timeline {
            background-color: var(--bg-main);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-radius: var(--corner-radius-lg);
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 15px;
            background: var(--bg-main);
            border-bottom: 1px solid #2A2D33;
            height: 36px;
        }

        .timeline-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            color: #5A5D65;
            text-shadow:
                0 1px 0 rgba(200, 205, 215, 0.5),
                0 -1px 0 rgba(0, 0, 0, 0.7);
        }

        /* Timeline Toolbar */
        .timeline-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #1A1A20;
            border-radius: 6px;
            padding: 3px;
            border: 1px solid #303040;
        }

        .tool-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #606070;
            transition: all 0.12s ease;
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #909098;
        }

        .tool-btn.active {
            background: var(--neon-orange);
            color: #FFFFFF;
            box-shadow: 0 0 8px rgba(255, 140, 0, 0.5);
        }

        .tool-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .toolbar-divider {
            width: 1px;
            height: 20px;
            background: #303040;
            margin: 0 2px;
        }

        /* Timeline Body - Split Layout */
        .timeline-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Track Headers Panel (Left) */
        .track-headers-panel {
            width: 150px;
            min-width: 100px;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
        }

        /* Resize Divider */
        .timeline-divider {
            width: 4px;
            background: #2A2D33;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.15s;
        }

        .timeline-divider:hover {
            background: #4A4D55;
        }

        .timeline-divider:active {
            background: var(--neon-cyan);
        }

        /* Track Content Panel (Right) */
        .track-content-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;  /* Hide all scrollbars - use custom scrollbar instead */
            background: var(--bg-main);
        }

        /* Time Ruler */
        .time-ruler {
            display: flex;
            height: 30px;
            background: var(--bg-main);
            border-bottom: 1px solid #2A2D33;
            flex-shrink: 0;
        }

        .time-ruler-header {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .expand-tracks-btn {
            width: 22px;
            height: 22px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 0;
            transition: all 0.3s ease;
        }

        .expand-tracks-btn:hover .expand-bar {
            background: #909090;
        }

        .expand-tracks-btn:hover .expand-arrow {
            border-left-color: #909090;
        }

        /* Three vertical bars */
        .expand-bar {
            width: 3px;
            height: 14px;
            background: #606570;
            border-radius: 1.5px;
        }

        .expand-bar:nth-child(1) { height: 10px; }
        .expand-bar:nth-child(2) { height: 14px; }
        .expand-bar:nth-child(3) { height: 10px; }

        /* Arrow pointing right */
        .expand-arrow {
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #606570;
            margin-left: 2px;
            transition: all 0.3s ease;
        }

        .track-headers-panel.expanded .expand-tracks-btn {
            transform: rotate(180deg);
        }

        .track-headers-panel.expanded .expand-bar {
            background: var(--neon-cyan);
        }

        .track-headers-panel.expanded .expand-arrow {
            border-left-color: var(--neon-cyan);
        }

        .time-ruler-content {
            flex: 1;
            display: flex;
            position: relative;
            cursor: pointer;
            background:
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 24px,
                    #353540 24px,
                    #353540 25px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 99px,
                    #454550 99px,
                    #454550 100px
                );
        }

        .bar-marker {
            position: absolute;
            top: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #909095;
        }

        .beat-tick {
            position: absolute;
            bottom: 0;
            width: 1px;
            background: #454550;
        }

        .beat-tick.bar {
            height: 12px;
            background: #606065;
        }

        .beat-tick.beat {
            height: 6px;
            background: #404045;
        }

        /* Chord Track - Same style as other tracks */
        .track-color-bar.chord { background: var(--track-chord); }

        /* Chord track content inherits from track-content-row */
        .chord-track-content {
            /* height inherited from .track-content-row */
        }

        .chord-block {
            position: absolute;
            top: 3px;
            bottom: 3px;
            background: var(--chord-border);
            border: 1px solid var(--chord-border);
            border-radius: 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            font-size: 12px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .chord-divider {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #505560;
            font-size: 16px;
        }

        /* Tracks Headers List (Left Panel) */
        .track-headers-list {
            flex: 1;
            overflow-y: auto;
            padding-top: 5px;  /* Match spacing between tracks */
        }

        .track-header-row {
            height: 48px;
            display: flex;
            align-items: center;
            padding: 0 6px;
            background: var(--bg-main);
        }

        .track-header-box {
            flex: 1;
            height: 46px;
            background: #353840;
            display: flex;
            align-items: center;
            padding: 0;
            font-size: 13px;
            border-radius: 8px;
            overflow: hidden;
        }

        .track-header-box.selected {
            background: #556070;
        }

        .track-color-bar {
            width: 5px;
            height: 100%;
            flex-shrink: 0;
        }

        .track-color-bar.drums { background: var(--track-drums); }
        .track-color-bar.bass { background: var(--track-bass); }
        .track-color-bar.piano { background: var(--track-piano); }
        .track-color-bar.vocal { background: var(--track-vocal); }

        /* Tracks Content List (Right Panel) */
        .track-content-list {
            flex: 1;
            overflow: hidden;  /* Hide all scrollbars - use custom scrollbar instead */
            position: relative;
            padding-top: 5px;  /* Match spacing between tracks */
            cursor: pointer;
            /* Dark background with grid for entire track content area */
            background:
                /* Bar lines (100px) - brighter, more visible */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 99px,
                    #3A3A45 99px,
                    #3A3A45 100px
                ),
                /* Beat lines (25px) - subtle */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 24px,
                    #1A1A22 24px,
                    #1A1A22 25px
                ),
                #101015;
        }

        .track-content-row {
            height: 48px;
            position: relative;
            background:
                /* Bar lines (100px) - brighter, more visible */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 99px,
                    #3A3A45 99px,
                    #3A3A45 100px
                ),
                /* Beat lines (25px) - subtle */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 24px,
                    #1A1A22 24px,
                    #1A1A22 25px
                ),
                #101015;
            border-bottom: 1px solid #252530;
        }

        .track-name {
            flex: 1;
            color: var(--text-main);
            padding-left: 10px;
        }

        .track-menu {
            display: grid;
            grid-template-columns: repeat(2, 4px);
            grid-template-rows: repeat(3, 4px);
            gap: 3px;
            cursor: pointer;
            margin-right: 10px;
        }

        .track-menu-dot {
            width: 4px;
            height: 4px;
            background: #505560;
            border-radius: 50%;
        }

        /* Track Header Expandable Controls */
        .track-headers-panel {
            transition: width 0.3s ease;
        }

        .track-headers-panel.expanded {
            width: 280px !important;
        }

        .track-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            margin-right: 8px;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, max-width 0.3s ease;
        }

        .track-headers-panel.expanded .track-controls {
            opacity: 1;
            max-width: 200px;
        }

        .track-headers-panel.expanded .track-name {
            flex: none;
            width: 50px;
        }

        /* Track Knob Controls */
        .track-knob-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .track-knob {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3A3D45;
            border: 2px solid;
            position: relative;
            cursor: pointer;
        }

        .track-knob.volume {
            border-color: #4FD272;
        }

        .track-knob.pan {
            border-color: #5DADE2;
        }

        /* Knob indicator line */
        .track-knob::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 8px;
            background: #FFFFFF;
            top: 3px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            transform-origin: bottom center;
            border-radius: 1px;
        }

        .track-knob.pan::after {
            transform: translateX(-50%) rotate(0deg);
        }

        .track-knob-label {
            font-size: 8px;
            color: #707580;
            text-transform: uppercase;
        }

        /* Track Control Buttons */
        .track-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #353840;
            color: #707580;
            transition: all 0.15s ease;
        }

        .track-btn:hover {
            background: #454A55;
        }

        .track-btn.mute {
            color: #707580;
        }

        .track-btn.mute.active {
            background: #FFB800;
            color: #1A1A20;
        }

        .track-btn.solo {
            color: #707580;
        }

        .track-btn.solo.active {
            background: #4FD272;
            color: #1A1A20;
        }

        .track-btn.rec {
            color: #707580;
        }

        .track-btn.rec.active {
            background: #FF4444;
            color: #FFFFFF;
        }

        /* Track Regions - Cubase style */
        .track-region {
            position: absolute;
            top: 3px;
            bottom: 3px;
            border-radius: 0px;
            border: 1px solid;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
            overflow: hidden;
        }

        .track-region .region-label {
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        /* Track-specific colors - Opaque (unselected) */
        .track-region.drums-region {
            background: var(--drums-border);
            border-color: var(--drums-border);
        }

        .track-region.bass-region {
            background: var(--bass-border);
            border-color: var(--bass-border);
        }

        .track-region.piano-region {
            background: var(--piano-border);
            border-color: var(--piano-border);
        }

        .track-region.vocal-region {
            background: var(--vocal-border);
            border-color: var(--vocal-border);
        }

        /* Selected clip style - Semi-transparent with brighter border */
        .track-region.drums-region.selected {
            background: rgba(232, 93, 78, 0.35);
            border-color: #FF8A7A;
        }
        .track-region.bass-region.selected {
            background: rgba(79, 210, 114, 0.35);
            border-color: #7FFF9A;
        }
        .track-region.piano-region.selected {
            background: rgba(93, 173, 226, 0.35);
            border-color: #8DDFFF;
        }
        .track-region.vocal-region.selected {
            background: rgba(157, 101, 216, 0.35);
            border-color: #C995FF;
        }
        .chord-block.selected {
            background: rgba(74, 144, 217, 0.35);
            border-color: #6AB0FF;
        }

        /* Drum patterns visualization */
        .drum-pattern {
            position: absolute;
            bottom: 4px;
            left: 6px;
            right: 6px;
            top: 18px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
        }

        .drum-hit {
            width: 8px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0px;
        }

        .drums-region.selected .drum-hit {
            background: var(--drums-border);
        }

        /* Bass/Piano waveform visualization */
        .waveform {
            position: absolute;
            bottom: 4px;
            left: 6px;
            right: 6px;
            top: 18px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .wave-bar {
            width: 3px;
            border-radius: 0px;
            background: rgba(255, 255, 255, 0.5);
        }

        .bass-region.selected .wave-bar {
            background: var(--bass-border);
        }

        .piano-region.selected .wave-bar {
            background: var(--piano-border);
        }

        /* Auto-fill ghost region */
        .auto-fill-region {
            position: absolute;
            top: 3px;
            bottom: 3px;
            border: 1px dashed var(--piano-border);
            border-radius: 0px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .auto-fill-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--piano-border);
        }

        .auto-fill-arrow {
            font-size: 14px;
        }

        /* Vocal region with waveform */
        .vocal-waveform {
            position: absolute;
            top: 18px;
            bottom: 4px;
            left: 6px;
            right: 6px;
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .vocal-wave {
            width: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0px;
        }

        .vocal-region.selected .vocal-wave {
            background: var(--vocal-border);
        }

        .vocal-circle {
            position: absolute;
            left: 6px;
            top: 18px;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vocal-region.selected .vocal-circle {
            border-color: var(--vocal-border);
        }

        .vocal-circle::after {
            content: '';
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        .vocal-region.selected .vocal-circle::after {
            background: var(--vocal-border);
        }

        /* Playhead - Neon Cyan */
        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #00FFFF;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 0 4px #00FFFF,
                        0 0 8px rgba(0, 255, 255, 0.6),
                        0 0 12px rgba(0, 255, 255, 0.3);
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 8px solid #00FFFF;
            filter: drop-shadow(0 0 4px #00FFFF);
        }

        /* Timeline scrollbar area - Cubase style */
        .timeline-scroll-area {
            height: 16px;
            background: #1A1A1E;
            display: flex;
            align-items: center;
            padding: 0;
            border-top: 1px solid #2A2A30;
        }

        .timeline-scroll {
            flex: 1;
            height: 100%;
            background: #1A1A1E;
            position: relative;
            display: flex;
            align-items: center;
        }

        .timeline-scroll-thumb {
            position: absolute;
            left: 50px;
            width: 120px;
            height: 10px;
            background: linear-gradient(180deg, #5A5A62 0%, #3A3A42 100%);
            border-radius: 2px;
            border: 1px solid #6A6A72;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
            cursor: grab;
        }

        .timeline-scroll-thumb:hover {
            background: linear-gradient(180deg, #6A6A72 0%, #4A4A52 100%);
            border-color: #7A7A82;
        }

        .timeline-scroll-thumb:active {
            cursor: grabbing;
            background: linear-gradient(180deg, #7A7A82 0%, #5A5A62 100%);
        }

        /* Vertical Scrollbar (Right side) - Cubase style */
        .timeline-vertical-scroll {
            width: 16px;
            background: #1A1A1E;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-left: 1px solid #2A2A30;
        }

        .vertical-scroll-track {
            flex: 1;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            padding: 4px 0;
        }

        .vertical-scroll-thumb {
            position: absolute;
            top: 30px;
            width: 10px;
            height: 100px;
            background: linear-gradient(90deg, #5A5A62 0%, #3A3A42 100%);
            border-radius: 2px;
            border: 1px solid #6A6A72;
            box-shadow: inset 1px 0 0 rgba(255,255,255,0.1);
            cursor: grab;
        }

        .vertical-scroll-thumb:hover {
            background: linear-gradient(90deg, #6A6A72 0%, #4A4A52 100%);
            border-color: #7A7A82;
        }

        .vertical-scroll-thumb:active {
            cursor: grabbing;
            background: linear-gradient(90deg, #7A7A82 0%, #5A5A62 100%);
        }

        /* Scroll corner (intersection of H and V scrollbars) */
        .scroll-corner {
            width: 16px;
            height: 16px;
            background: #1A1A1E;
            flex-shrink: 0;
        }

        /* Detail Editor - Cubase Style */
        .detail-editor {
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            border-radius: var(--corner-radius-lg);
            overflow: hidden;
        }

        .detail-editor-header {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            background: var(--bg-main);
            border-bottom: 1px solid #2A2D33;
            padding: 0 12px;
            position: relative;
        }

        .detail-editor-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            color: #5A5D65;
            text-shadow:
                0 1px 0 rgba(200, 205, 215, 0.5),
                0 -1px 0 rgba(0, 0, 0, 0.7);
        }

        /* Edit Dock Tabs */
        .edit-dock-tabs {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 100%;
            position: absolute;
            left: 12px;
        }

        .edit-dock-tab {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #808590;
            padding: 8px 16px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.15s;
        }

        .edit-dock-tab:hover {
            color: #C0C6C5;
            background: rgba(255,255,255,0.03);
        }

        .edit-dock-tab.active {
            background: #3A3D45;
            color: #C0C6C5;
            border-bottom: 2px solid #4DFFFF;
        }

        .editor-tabs {
            display: none;
        }

        .editor-tab {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }

        .editor-tab:hover {
            color: var(--text-main);
            background: rgba(255,255,255,0.05);
        }

        .editor-tab.active {
            background: #2A2D35;
            color: var(--text-main);
        }

        /* Edit Dock Panels */
        .edit-dock-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .edit-dock-panel.active {
            display: flex;
        }

        .empty-panel-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 18px;
            font-weight: 500;
            background: #1A1A20;
        }

        /* ==================== Step Sequencer Styles ==================== */
        /* Wrapper - Centers the neon box */
        .step-seq-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0D1117;
            padding: 15px;
        }

        /* Main Container - Outer Neon Border Box */
        .step-seq-container {
            display: flex;
            background: rgba(15, 20, 30, 0.9);
            border: 2px solid #4DFFFF;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(77, 255, 255, 0.4), inset 0 0 30px rgba(0, 0, 0, 0.5);
            padding: 10px;
            gap: 0;
        }

        /* Left - Track Headers */
        .step-seq-tracks {
            width: 150px;
            min-width: 150px;
            display: flex;
            flex-direction: column;
        }

        .step-seq-track-header {
            height: 56px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 6px;
        }

        /* Track header backgrounds - darker version of track color */
        .step-seq-track-header[data-track="kick"] {
            background: rgba(255, 107, 107, 0.25);
            border-left: 3px solid #FF6B6B;
        }
        .step-seq-track-header[data-track="snare"] {
            background: rgba(77, 255, 255, 0.18);
            border-left: 3px solid #4DFFFF;
        }
        .step-seq-track-header[data-track="hihat"] {
            background: rgba(79, 210, 114, 0.25);
            border-left: 3px solid #4FD272;
        }
        .step-seq-track-header[data-track="perc"] {
            background: rgba(212, 95, 255, 0.22);
            border-left: 3px solid #D45FFF;
        }

        .smart-rand-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(30, 35, 45, 0.9);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(77, 255, 255, 0.2);
        }

        .smart-rand-btn:hover {
            background: rgba(50, 55, 65, 0.9);
            box-shadow: 0 0 12px rgba(77, 255, 255, 0.4);
            border-color: #4DFFFF;
        }

        .smart-rand-btn .dice-icon {
            width: 28px;
            height: 28px;
            color: #4DFFFF;
        }

        .smart-rand-label {
            display: none;
        }

        .step-seq-track-name {
            font-size: 13px;
            font-weight: 600;
        }

        /* Add Track Button */
        .step-seq-add-track {
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .step-seq-add-track:hover .add-icon {
            text-shadow: 0 0 20px rgba(77, 255, 255, 0.9);
            transform: scale(1.1);
        }

        .step-seq-add-track .add-icon {
            font-size: 24px;
            font-weight: 300;
            color: #4DFFFF;
            text-shadow: 0 0 12px rgba(77, 255, 255, 0.6);
            line-height: 1;
            transition: all 0.2s ease;
        }

        /* Center - Grid Area with Inner Neon Border */
        .step-seq-grid-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4DFFFF;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(77, 255, 255, 0.2);
            margin: 0 10px;
            overflow: hidden;
        }

        /* Ruler with tick marks */
        .step-seq-ruler {
            height: 28px;
            display: flex;
            align-items: flex-end;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(77, 255, 255, 0.3);
            padding: 0 6px;
        }

        .step-seq-ruler-beat {
            display: flex;
            align-items: flex-end;
            padding-right: 8px;
            margin-right: 8px;
            border-right: 1px solid rgba(77, 255, 255, 0.2);
        }

        .step-seq-ruler-beat:last-child {
            margin-right: 0;
            padding-right: 0;
            border-right: none;
        }

        .ruler-tick {
            width: 24px;
            height: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-right: 2px;
            position: relative;
        }

        .ruler-tick:last-child {
            margin-right: 0;
        }

        .ruler-tick .beat-label {
            font-size: 11px;
            font-weight: 600;
            color: #4DFFFF;
            text-shadow: 0 0 8px rgba(77, 255, 255, 0.5);
        }

        /* Grid container with scrollbars */
        .step-seq-grid-scroll {
            flex: 1;
            overflow: auto;
            padding: 6px;
            position: relative;
        }

        /* Wave Visualizer - SVG Fluid Wave */
        .wave-visualizer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
            overflow: hidden;
        }

        #wave-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));
        }

        .wave-visualizer.playing #wave-svg {
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.6));
        }

        .step-seq-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            z-index: 1;
        }

        .step-seq-row {
            height: 56px;
            display: flex;
            align-items: center;
            gap: 0;
            position: relative;
        }

        /* Beat group with separator */
        .step-beat-group {
            display: flex;
            gap: 2px;
            padding-right: 8px;
            margin-right: 8px;
            border-right: 1px solid rgba(77, 255, 255, 0.2);
            position: relative;
        }

        .step-beat-group:last-child {
            margin-right: 0;
            padding-right: 0;
            border-right: none;
        }

        /* Step cell - double border structure */
        .step-cell {
            width: 24px;
            height: 48px;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Outer border */
            border: 2px solid transparent;
            /* Inner border via box-shadow */
            box-shadow: inset 0 0 0 1px rgba(128, 128, 128, 0.25);
        }

        /* Inactive step - double border structure (outer + inner) */
        .step-seq-row[data-color="#FF6B6B"] .step-cell {
            border: 1px solid rgba(255, 107, 107, 0.35);
            box-shadow: inset 0 0 0 1px rgba(255, 107, 107, 0.15);
        }
        .step-seq-row[data-color="#4DFFFF"] .step-cell {
            border: 1px solid rgba(77, 255, 255, 0.35);
            box-shadow: inset 0 0 0 1px rgba(77, 255, 255, 0.15);
        }
        .step-seq-row[data-color="#4FD272"] .step-cell {
            border: 1px solid rgba(79, 210, 114, 0.35);
            box-shadow: inset 0 0 0 1px rgba(79, 210, 114, 0.15);
        }
        .step-seq-row[data-color="#D45FFF"] .step-cell {
            border: 1px solid rgba(212, 95, 255, 0.35);
            box-shadow: inset 0 0 0 1px rgba(212, 95, 255, 0.15);
        }

        .step-cell:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Active step - Neon glow style with inner border */
        .step-seq-row[data-color="#FF6B6B"] .step-cell.active {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #FF6B6B;
            box-shadow: 0 0 12px #FF6B6B, 0 0 20px rgba(255, 107, 107, 0.4), inset 0 0 0 3px rgba(0, 0, 0, 0.3), inset 0 0 0 4px rgba(255, 107, 107, 0.6);
        }

        .step-seq-row[data-color="#4DFFFF"] .step-cell.active {
            background: rgba(77, 255, 255, 0.3);
            border: 2px solid #4DFFFF;
            box-shadow: 0 0 12px #4DFFFF, 0 0 20px rgba(77, 255, 255, 0.4), inset 0 0 0 3px rgba(0, 0, 0, 0.3), inset 0 0 0 4px rgba(77, 255, 255, 0.6);
        }

        .step-seq-row[data-color="#4FD272"] .step-cell.active {
            background: rgba(79, 210, 114, 0.3);
            border: 2px solid #4FD272;
            box-shadow: 0 0 12px #4FD272, 0 0 20px rgba(79, 210, 114, 0.4), inset 0 0 0 3px rgba(0, 0, 0, 0.3), inset 0 0 0 4px rgba(79, 210, 114, 0.6);
        }

        .step-seq-row[data-color="#D45FFF"] .step-cell.active {
            background: rgba(212, 95, 255, 0.3);
            border: 2px solid #D45FFF;
            box-shadow: 0 0 12px #D45FFF, 0 0 20px rgba(212, 95, 255, 0.4), inset 0 0 0 3px rgba(0, 0, 0, 0.3), inset 0 0 0 4px rgba(212, 95, 255, 0.6);
        }

        /* Ghost step */
        .step-seq-row[data-color="#FF6B6B"] .step-cell.ghost {
            background: rgba(255, 107, 107, 0.08);
            box-shadow: inset 0 0 0 1px rgba(255, 107, 107, 0.3);
        }

        .step-seq-row[data-color="#4DFFFF"] .step-cell.ghost {
            background: rgba(77, 255, 255, 0.08);
            box-shadow: inset 0 0 0 1px rgba(77, 255, 255, 0.3);
        }

        .step-seq-row[data-color="#4FD272"] .step-cell.ghost {
            background: rgba(79, 210, 114, 0.08);
            box-shadow: inset 0 0 0 1px rgba(79, 210, 114, 0.3);
        }

        .step-seq-row[data-color="#D45FFF"] .step-cell.ghost {
            background: rgba(212, 95, 255, 0.08);
            box-shadow: inset 0 0 0 1px rgba(212, 95, 255, 0.3);
        }

        /* Ratchet label */
        .ratchet-label {
            position: absolute;
            top: 3px;
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        }

        /* Custom scrollbar for grid */
        .step-seq-grid-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .step-seq-grid-scroll::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .step-seq-grid-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4DFFFF, #3AC9C9);
            border-radius: 4px;
        }

        .step-seq-grid-scroll::-webkit-scrollbar-corner {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Current Step Highlight (Playing Position) */
        .step-cell.current {
            position: relative;
        }

        .step-cell.current::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            animation: stepPulse 0.2s ease-out;
            pointer-events: none;
        }

        @keyframes stepPulse {
            0% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.6;
            }
        }

        /* Current step with neon wave effect per track color */
        .step-seq-row[data-color="#FF6B6B"] .step-cell.current::before {
            border-color: #FF6B6B;
            box-shadow: 0 0 15px #FF6B6B, 0 0 30px rgba(255, 107, 107, 0.5);
        }
        .step-seq-row[data-color="#4DFFFF"] .step-cell.current::before {
            border-color: #4DFFFF;
            box-shadow: 0 0 15px #4DFFFF, 0 0 30px rgba(77, 255, 255, 0.5);
        }
        .step-seq-row[data-color="#4FD272"] .step-cell.current::before {
            border-color: #4FD272;
            box-shadow: 0 0 15px #4FD272, 0 0 30px rgba(79, 210, 114, 0.5);
        }
        .step-seq-row[data-color="#D45FFF"] .step-cell.current::before {
            border-color: #D45FFF;
            box-shadow: 0 0 15px #D45FFF, 0 0 30px rgba(212, 95, 255, 0.5);
        }

        /* Edit Dock Focus State */
        .edit-dock-tab.focused {
            background: rgba(0, 255, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        /* Right - Control Panel */
        .step-seq-controls {
            width: 90px;
            min-width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 5px;
            gap: 10px;
        }

        .kit-morph-btn {
            width: 70px;
            height: 60px;
            background: transparent;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            --morph-color: #4DFFFF;
        }

        .kit-morph-btn:hover .morph-icon {
            color: #fff;
            filter: drop-shadow(0 0 10px var(--morph-color)) drop-shadow(0 0 20px var(--morph-color));
        }

        .kit-morph-btn:hover .kit-morph-label {
            color: #fff;
            text-shadow: 0 0 10px var(--morph-color), 0 0 20px var(--morph-color), 0 0 30px var(--morph-color);
        }

        .kit-morph-btn .morph-icon {
            width: 28px;
            height: 28px;
            color: var(--morph-color);
            transition: all 0.3s ease;
        }

        .kit-morph-label {
            font-size: 10px;
            color: var(--morph-color);
            margin-top: 3px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Kit Morph 활성화 애니메이션 */
        .kit-morph-btn.morphing .morph-icon {
            animation: morphSpin 0.5s ease-out;
        }

        @keyframes morphSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .kit-morph-btn.morphing .morph-icon,
        .kit-morph-btn.morphing .kit-morph-label {
            color: var(--morph-color);
            filter: drop-shadow(0 0 15px var(--morph-color)) drop-shadow(0 0 30px var(--morph-color));
        }

        .humanize-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .humanize-label {
            font-size: 11px;
            color: #C0C6D0;
            font-weight: 500;
        }

        .humanize-slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .humanize-slider-track {
            width: 6px;
            height: 60px;
            background: rgba(30, 35, 45, 0.9);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(77, 255, 255, 0.2);
        }

        .humanize-slider-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #4DFFFF, #3AC9C9);
            border-radius: 3px;
            transition: height 0.2s ease;
        }

        .humanize-value {
            font-size: 11px;
            color: #4DFFFF;
            font-weight: 600;
        }

        /* Step count toggle button */
        .step-count-toggle {
            margin-top: auto;
            padding: 8px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .step-count-toggle:hover .step-count-value,
        .step-count-toggle:hover .step-count-label {
            color: #fff;
            text-shadow: 0 0 10px #4DFFFF, 0 0 20px #4DFFFF, 0 0 30px #4DFFFF;
        }

        .step-count-toggle .step-count-value {
            font-size: 14px;
            font-weight: 700;
            color: #4DFFFF;
            transition: all 0.2s ease;
        }

        .step-count-toggle .step-count-label {
            font-size: 9px;
            color: #4DFFFF;
            text-transform: uppercase;
            transition: all 0.2s ease;
        }
        /* ==================== End Step Sequencer Styles ==================== */

        /* ==================== Mixer Panel Styles (FL Studio Style) ==================== */
        .mixer-wrapper {
            flex: 1;
            display: flex;
            background: #0D1117;
            padding: 10px;
        }

        .mixer-content {
            flex: 1;
            background: rgba(15, 20, 30, 0.9);
            border: 2px solid #4DFFFF;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(77, 255, 255, 0.4), inset 0 0 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: stretch;
            padding: 10px 12px;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 4px;
        }

        .mixer-content::-webkit-scrollbar { height: 8px; }
        .mixer-content::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 4px; }
        .mixer-content::-webkit-scrollbar-thumb { background: linear-gradient(90deg, #4DFFFF, #3AC9C9); border-radius: 4px; }

        /* Channel Strip - FL Studio Style (Slim) */
        .channel-strip {
            width: 52px;
            min-width: 52px;
            height: 100%;
            background: linear-gradient(180deg, rgba(40, 45, 55, 0.95), rgba(28, 32, 40, 0.95));
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            position: relative;
            flex-shrink: 0;
            border: 1px solid rgba(77, 255, 255, 0.1);
            transition: all 0.2s ease;
            overflow: visible;
        }

        .channel-strip:hover {
            border-color: rgba(77, 255, 255, 0.4);
            box-shadow: 0 0 12px rgba(77, 255, 255, 0.15);
        }

        .channel-strip.selected {
            border-color: rgba(77, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(77, 255, 255, 0.3), inset 0 0 20px rgba(77, 255, 255, 0.05);
        }

        .channel-strip.master-strip {
            width: 58px;
            min-width: 58px;
            background: linear-gradient(180deg, rgba(50, 45, 35, 0.95), rgba(35, 32, 25, 0.95));
            border-color: rgba(255, 215, 0, 0.25);
        }

        .channel-strip.master-strip:hover {
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .channel-strip.master-strip.selected {
            border-color: rgba(255, 215, 0, 0.7);
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.05);
        }

        /* Track Name Header (세로 텍스트 + 컬러바) */
        .mixer-track-header {
            width: 100%;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            padding-top: 4px;
        }

        .mixer-color-bar {
            width: 100%;
            height: 3px;
            margin-bottom: 6px;
        }

        .mixer-track-name-vertical {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            font-size: 10px;
            font-weight: 600;
            color: #ddd;
            letter-spacing: 1px;
            text-transform: uppercase;
            max-height: 55px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Control Buttons Row */
        .mixer-controls-row {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }

        .btn-mixer-ctrl {
            width: 20px;
            height: 18px;
            font-size: 10px;
            font-weight: 700;
            background: transparent;
            color: #555;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-mixer-ctrl:hover {
            border-color: #666;
            color: #888;
        }

        .btn-mixer-ctrl.active-mute {
            background: transparent;
            color: #FFB800;
            border-color: #FFB800;
            box-shadow: 0 0 8px rgba(255, 184, 0, 0.6), 0 0 16px rgba(255, 184, 0, 0.3);
            text-shadow: 0 0 8px #FFB800;
        }

        .btn-mixer-ctrl.active-solo {
            background: transparent;
            color: #4FD272;
            border-color: #4FD272;
            box-shadow: 0 0 8px rgba(79, 210, 114, 0.6), 0 0 16px rgba(79, 210, 114, 0.3);
            text-shadow: 0 0 8px #4FD272;
        }

        /* Fader + Level Meter Area (FL Studio Core) */
        .mixer-fader-section {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 3px;
            padding: 6px 2px;
            width: 100%;
            overflow: visible;
        }

        /* Level Meter (세로 바) */
        .level-meter {
            width: 6px;
            height: 100%;
            background: #1a1a20;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }

        .level-meter-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top,
                #FF00FF 0%,
                #AA00FF 35%,
                #8B00FF 55%,
                #00CCFF 80%,
                #00FFFF 100%);
            border-radius: 1px;
            transition: height 0.1s ease;
            box-shadow: 0 0 6px rgba(170, 0, 255, 0.5);
        }

        /* Fader (중앙) */
        .mixer-fader-track {
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #252530, #1a1a20);
            border-radius: 3px;
            position: relative;
            border: 1px solid #3a3a45;
            overflow: visible;
        }

        .mixer-fader-thumb {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 22px;
            height: 18px;
            background: linear-gradient(180deg, #666, #444);
            border-radius: 2px;
            cursor: grab;
            border: 1px solid #888;
            box-shadow: 0 0 6px var(--fader-color, rgba(77, 255, 255, 0.3));
            z-index: 5;
        }

        .mixer-fader-thumb::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 1px;
            background: var(--fader-color, #4DFFFF);
            box-shadow: 0 -3px 0 var(--fader-color, #4DFFFF), 0 3px 0 var(--fader-color, #4DFFFF);
            opacity: 0.9;
        }

        /* Volume Display */
        .mixer-vol-display {
            width: 100%;
            text-align: center;
            padding: 4px 0 6px 0;
            font-size: 9px;
            font-family: 'Consolas', monospace;
            color: #4DFFFF;
            background: rgba(0, 0, 0, 0.3);
        }

        .master-strip .mixer-vol-display {
            color: #FFD700;
        }

        /* Separator */
        .mixer-separator {
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, transparent 5%, rgba(255, 215, 0, 0.3) 50%, transparent 95%);
            margin: 0 4px;
            flex-shrink: 0;
        }

        /* Master specific */
        .master-strip .mixer-track-name-vertical {
            color: #FFD700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        /* FX Channel */
        .fx-strip {
            background: linear-gradient(180deg, rgba(60, 40, 50, 0.95), rgba(40, 28, 35, 0.95));
            border-color: rgba(255, 107, 157, 0.2);
        }

        .fx-strip:hover {
            border-color: rgba(255, 107, 157, 0.5);
            box-shadow: 0 0 12px rgba(255, 107, 157, 0.2);
        }

        .fx-strip.selected {
            border-color: rgba(255, 107, 157, 0.7);
            box-shadow: 0 0 15px rgba(255, 107, 157, 0.4), inset 0 0 20px rgba(255, 107, 157, 0.05);
        }

        .fx-strip .mixer-track-name-vertical {
            color: #FF6B9D;
            text-shadow: 0 0 6px rgba(255, 107, 157, 0.5);
        }

        /* Group Channel */
        .group-strip {
            background: linear-gradient(180deg, rgba(30, 50, 60, 0.95), rgba(20, 35, 45, 0.95));
            border-color: rgba(0, 191, 255, 0.2);
        }

        .group-strip:hover {
            border-color: rgba(0, 191, 255, 0.5);
            box-shadow: 0 0 12px rgba(0, 191, 255, 0.2);
        }

        .group-strip.selected {
            border-color: rgba(0, 191, 255, 0.7);
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.4), inset 0 0 20px rgba(0, 191, 255, 0.05);
        }

        .group-strip .mixer-track-name-vertical {
            color: #00BFFF;
            text-shadow: 0 0 6px rgba(0, 191, 255, 0.5);
        }

        /* AI Smart Knob */
        .smart-knob-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            margin-bottom: 2px;
        }

        .smart-knob {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #3a3a45, #1a1a20);
            border: 2px solid #444;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        .smart-knob:hover {
            border-color: var(--knob-color, #4DFFFF);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 10px var(--knob-color, rgba(77, 255, 255, 0.3));
        }

        .smart-knob.active {
            border-color: var(--knob-color, #4DFFFF);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 12px var(--knob-color, rgba(77, 255, 255, 0.5));
        }

        .smart-knob-indicator {
            position: absolute;
            top: 3px;
            left: 50%;
            width: 2px;
            height: 8px;
            background: #555;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(var(--knob-rotation, 0deg));
            border-radius: 1px;
            transition: background 0.2s ease;
        }

        .smart-knob:hover .smart-knob-indicator,
        .smart-knob.active .smart-knob-indicator {
            background: var(--knob-color, #4DFFFF);
            box-shadow: 0 0 4px var(--knob-color, #4DFFFF);
        }

        .smart-knob-label {
            font-size: 7px;
            font-weight: 700;
            color: #666;
            margin-top: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .smart-knob-wrapper:hover .smart-knob-label {
            color: var(--knob-color, #4DFFFF);
            text-shadow: 0 0 6px var(--knob-color, rgba(77, 255, 255, 0.5));
        }

        .smart-knob.active + .smart-knob-label {
            color: var(--knob-color, #4DFFFF);
            text-shadow: 0 0 6px var(--knob-color, rgba(77, 255, 255, 0.5));
        }

        /* Smart Knob Value Display (on hover) */
        .smart-knob-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: 600;
            color: var(--knob-color, #4DFFFF);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 5px;
            border-radius: 3px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }

        .smart-knob-wrapper:hover .smart-knob-value {
            opacity: 1;
        }
        /* ==================== End Mixer Panel Styles ==================== */

        .editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* AI Modifier Panel */
        .ai-modifier {
            width: 120px;
            background: #252830;
            padding: 12px;
            border-right: 1px solid #2A2D33;
            flex-shrink: 0;
        }

        .modifier-title {
            color: var(--neon-cyan);
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .slider-group {
            margin-bottom: 12px;
        }

        .slider-label {
            color: var(--text-muted);
            font-size: 10px;
            margin-bottom: 4px;
        }

        .slider-bar {
            height: 6px;
            background: #1A1A20;
            border-radius: 3px;
            overflow: hidden;
        }

        .slider-fill {
            height: 100%;
            background: var(--track-bass);
            border-radius: 3px;
        }

        /* Piano Roll Container */
        .piano-roll {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Piano Roll Time Ruler */
        .piano-roll-ruler {
            height: 24px;
            display: flex;
            background: #1A1A20;
            border-bottom: 1px solid #3A3D45;
            flex-shrink: 0;
        }

        .piano-roll-ruler-corner {
            width: 65px;
            background: #1A1A20;
            border-right: 1px solid #2A2D33;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .midi-clip-name {
            font-size: 9px;
            color: #E85D5D;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .piano-roll-ruler-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background:
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 24px,
                    #252830 24px,
                    #252830 25px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 99px,
                    #3A3D45 99px,
                    #3A3D45 100px
                );
        }

        .piano-roll-bar-marker {
            position: absolute;
            top: 4px;
            font-size: 10px;
            font-weight: 500;
            color: #808590;
        }

        .piano-roll-bar-marker .bar-beat {
            color: #606570;
            margin-left: 2px;
        }

        .piano-roll-beat-marker {
            position: absolute;
            top: 4px;
            font-size: 9px;
            color: #505560;
        }

        /* Piano Roll Body */
        .piano-roll-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Piano Keys - Cubase Style (Real Piano Layout) */
        .piano-keys {
            width: 65px;
            background: #1A1A20;
            flex-shrink: 0;
            position: relative;
            border-right: 1px solid #2A2D33;
            overflow: hidden;
        }

        /* White keys - full height, sequential */
        .piano-key-white {
            position: absolute;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #909090 0%, #C8C8C8 40%, #E0E0E0 60%, #D0D0D0 100%);
            border-bottom: 1px solid #707070;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 3px;
            font-size: 8px;
            color: #404040;
            box-sizing: border-box;
            z-index: 1;
        }

        .piano-key-white.c-key {
            font-weight: bold;
        }

        /* Black keys - shorter, overlay on white keys */
        .piano-key-black {
            position: absolute;
            left: 0;
            width: 65%;
            background: linear-gradient(90deg, #101010 0%, #252525 50%, #1A1A1A 100%);
            border-radius: 0 2px 2px 0;
            box-shadow: 2px 0 3px rgba(0,0,0,0.5);
            z-index: 2;
        }

        /* MIDI Grid Area */
        .midi-grid-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .midi-grid {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #252830;
        }

        /* Grid Lines */
        .midi-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background:
                /* Bar lines (100px) - bright */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 99px,
                    #404550 99px,
                    #404550 100px
                ),
                /* Beat lines (25px) - subtle */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 24px,
                    #2A2D35 24px,
                    #2A2D35 25px
                );
        }

        /* Horizontal row backgrounds for piano keys - Cubase Style */
        .midi-grid-rows {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .midi-row {
            position: absolute;
            left: 0;
            right: 0;
            height: 14px;
            border-bottom: 1px solid #1E2028;
        }

        .midi-row.white-key {
            background: #2A2D35;
        }

        .midi-row.black-key {
            background: #1E2128;
        }

        .midi-row.c-row {
            border-bottom: 1px solid #3A3D45;
        }

        /* MIDI Notes - Cubase Red Style */
        .midi-note {
            position: absolute;
            height: 14px;
            background: linear-gradient(180deg, #E85D5D 0%, #C94545 100%);
            border-radius: 2px;
            border: 1px solid #FF7070;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding-left: 4px;
            font-size: 9px;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            overflow: hidden;
        }

        .midi-note:hover {
            background: linear-gradient(180deg, #FF6B6B 0%, #D55050 100%);
            border-color: #FF8080;
        }

        .midi-note.selected {
            background: linear-gradient(180deg, #FF7070 0%, #E05555 100%);
            border-color: #FFAAAA;
            box-shadow: 0 0 6px rgba(255,100,100,0.5);
        }

        /* Velocity Lane - Cubase Style (Below Piano Roll) */
        .velocity-section {
            height: 70px;
            background: #1A1A20;
            border-top: 1px solid #3A3D45;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .velocity-lane {
            flex: 1;
            display: flex;
            background: #1A1A20;
        }

        .velocity-header {
            width: 65px;
            display: flex;
            flex-direction: column;
            background: #1A1A20;
            border-right: 1px solid #2A2D33;
        }

        .velocity-label-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .velocity-grid {
            flex: 1;
            position: relative;
            background:
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 99px,
                    #2A2D35 99px,
                    #2A2D35 100px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 24px,
                    #1F2228 24px,
                    #1F2228 25px
                ),
                #1A1A20;
        }

        .velocity-max-label {
            width: 35px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 4px;
            font-size: 10px;
            color: #606570;
            background: #1A1A20;
        }

        .velocity-bar {
            position: absolute;
            bottom: 0;
            width: 6px;
            background: linear-gradient(180deg, #E85D5D 0%, #B84040 100%);
            border-radius: 1px 1px 0 0;
        }

        /* Velocity Bottom Controls - Cubase Style */
        .velocity-bottom-bar {
            height: 22px;
            display: flex;
            background: #252830;
            border-top: 1px solid #2A2D33;
        }

        .velocity-controls-left {
            width: 65px;
            display: flex;
            align-items: center;
            padding: 0 4px;
            gap: 4px;
            border-right: 1px solid #2A2D33;
        }

        .velocity-add-btn {
            width: 18px;
            height: 16px;
            background: #3A3D45;
            border: 1px solid #4A4D55;
            border-radius: 2px;
            color: #909090;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .velocity-add-btn:hover {
            background: #4A4D55;
            color: #C0C0C0;
        }

        .velocity-dropdown-btn {
            width: 18px;
            height: 16px;
            background: #3A3D45;
            border: 1px solid #4A4D55;
            border-radius: 2px;
            color: #909090;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .velocity-dropdown-btn:hover {
            background: #4A4D55;
            color: #C0C0C0;
        }

        /* Piano Roll Scrollbar - Cubase Style */
        .piano-roll-scrollbar {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 0 8px;
            background: #1A1A1E;
        }

        .piano-roll-scroll-track {
            flex: 1;
            height: 10px;
            background: #101015;
            border-radius: 2px;
            position: relative;
        }

        .piano-roll-scroll-thumb {
            position: absolute;
            left: 10%;
            width: 25%;
            height: 100%;
            background: linear-gradient(180deg, #5A5A62 0%, #3A3A42 100%);
            border-radius: 2px;
            border: 1px solid #6A6A72;
            cursor: grab;
        }

        .piano-roll-scroll-thumb:hover {
            background: linear-gradient(180deg, #6A6A72 0%, #4A4A52 100%);
        }

        /* Piano Roll Playhead - Neon Cyan */
        .piano-roll-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #00FFFF;
            z-index: 50;
            pointer-events: none;
            box-shadow: 0 0 4px #00FFFF,
                        0 0 8px rgba(0, 255, 255, 0.6),
                        0 0 12px rgba(0, 255, 255, 0.3);
        }

        .piano-roll-playhead::before {
            content: '';
            position: absolute;
            top: -24px;
            left: -4px;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 7px solid #00FFFF;
            filter: drop-shadow(0 0 4px #00FFFF);
        }

        /* AI Copilot (Right Sidebar) */
        .ai-copilot {
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            padding: 0 15px 15px 15px;
            border-radius: var(--corner-radius-lg);
        }

        .copilot-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            color: #5A5D65;
            text-shadow:
                0 1px 0 rgba(200, 205, 215, 0.5),
                0 -1px 0 rgba(0, 0, 0, 0.7);
            text-align: center;
            padding: 6px 0;
            border-bottom: 1px solid #2A2D33;
            margin-bottom: 15px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
        }

        .chat-bubble {
            border-radius: var(--corner-radius);
            padding: 12px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .chat-bubble.user {
            background: var(--chat-user);
        }

        .chat-bubble.ai {
            background: var(--chat-ai);
        }

        .chat-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--bg-panel);
            border-radius: var(--corner-radius);
            color: var(--text-main);
            padding: 10px;
            font-size: 12px;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            background: var(--neon-cyan);
            border: none;
            color: var(--bg-main);
            width: 35px;
            height: 35px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="project-name">Rain-Fi</span>
                <div class="undo-redo-group">
                    <button class="undo-redo-btn" title="Undo">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 9h10c3.5 0 6 2.5 6 6s-2.5 6-6 6H8"/>
                            <polyline points="7 5 3 9 7 13"/>
                        </svg>
                    </button>
                    <button class="undo-redo-btn" title="Redo">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 9H11c-3.5 0-6 2.5-6 6s2.5 6 6 6h5"/>
                            <polyline points="17 5 21 9 17 13"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="header-center">
                <div class="transport-group">
                    <button class="transport-btn play-btn">
                        <div class="play-icon"></div>
                    </button>
                    <button class="transport-btn stop-btn">
                        <div class="stop-icon"></div>
                    </button>
                    <button class="rec-btn">
                        <div class="circle"></div>
                    </button>
                    <div class="transport-divider"></div>
                    <div class="tempo-box">
                        <div class="bpm-control">
                            <span class="bpm-value" id="bpmValue">120.000</span>
                            <div class="bpm-arrows">
                                <button class="bpm-arrow" id="bpmUp">
                                    <svg viewBox="0 0 10 6" fill="currentColor">
                                        <path d="M5 0L10 6H0L5 0Z"/>
                                    </svg>
                                </button>
                                <button class="bpm-arrow" id="bpmDown">
                                    <svg viewBox="0 0 10 6" fill="currentColor">
                                        <path d="M5 6L0 0H10L5 6Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <span class="key-display">Key: C Major</span>
                    </div>
                </div>
                <!-- Metronome Button - 독립적 배치 (transport-group 바깥) -->
                <button class="metronome-btn" id="metronomeBtn" title="Metronome (M)">
                    <div class="metronome-icon">
                        <svg viewBox="0 0 24 24">
                            <!-- Body - 둥근 사다리꼴 -->
                            <path class="metro-body" d="M8 21 L6.5 21 C6 21 5.7 20.7 5.8 20.2 L9.5 4.5 C9.7 3.8 10.3 3.5 11 3.5 L13 3.5 C13.7 3.5 14.3 3.8 14.5 4.5 L18.2 20.2 C18.3 20.7 18 21 17.5 21 L16 21" stroke-linejoin="round"/>
                            <!-- 눈금 마크 -->
                            <rect class="metro-tick" x="11" y="8" width="2" height="1" rx="0.5"/>
                            <rect class="metro-tick" x="11" y="11" width="2" height="1" rx="0.5"/>
                            <rect class="metro-tick" x="11" y="14" width="2" height="1" rx="0.5"/>
                            <!-- 펜듈럼 그룹 - 아래 축 중심, 웨이트는 위 -->
                            <g class="metro-pendulum-group">
                                <line class="metro-pendulum" x1="12" y1="6" x2="12" y2="18"/>
                                <circle class="metro-weight" cx="12" cy="8" r="2"/>
                            </g>
                        </svg>
                    </div>
                </button>
            </div>
            <div class="header-right">
                <button class="magic-mix-btn">Magic Mix</button>
                <button class="export-btn">Export</button>
                <button class="icon-btn" title="Mixer">
                    <div class="mixer-icon">
                        <div class="mixer-bar"></div>
                        <div class="mixer-bar"></div>
                        <div class="mixer-bar"></div>
                        <div class="mixer-bar"></div>
                    </div>
                </button>
                <button class="icon-btn" title="Project Meta">
                    <div class="disc-icon"></div>
                </button>
            </div>
        </header>

        <!-- Resource Browser -->
        <aside class="resource-browser">
            <div class="sidebar-section">
                <div class="section-title">AI Generate</div>
                <div class="ai-generate-box">
                    <div class="desc">Describe the music you want to create</div>
                    <textarea class="prompt-input" placeholder="Enter prompt...">Rainy day lo-fi hip-hop</textarea>
                    <button class="generate-btn">Generate</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="menu-item">Instruments</div>
                <div class="menu-item">My Samples</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Timeline -->
            <section class="timeline">
                <!-- Timeline Header -->
                <div class="timeline-header">
                    <span class="timeline-title">Timeline View</span>
                    <!-- Timeline Toolbar -->
                    <div class="timeline-toolbar" id="timelineToolbar">
                        <!-- Select Tool (1) -->
                        <button class="tool-btn active" data-tool="select" title="Select/Move (1)">
                            <svg viewBox="0 0 24 24">
                                <path d="M4 3l8 5-8 5V3zm9 7.5L19 21h-3l-1.5-3-3 1.5L13 10.5z"/>
                            </svg>
                        </button>
                        <!-- Split Tool (2) -->
                        <button class="tool-btn" data-tool="split" title="Split (2)">
                            <svg viewBox="0 0 24 24">
                                <path d="M11 3v18M4 12h6M14 12h6M7 8l4 4-4 4M17 8l-4 4 4 4"/>
                            </svg>
                        </button>
                        <!-- Draw Tool (3) -->
                        <button class="tool-btn" data-tool="draw" title="Draw (3)">
                            <svg viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <!-- Eraser Tool (4) -->
                        <button class="tool-btn" data-tool="eraser" title="Eraser (4)">
                            <svg viewBox="0 0 24 24">
                                <path d="M16.24 3.56a3 3 0 00-4.24 0L3.56 12l4.24 4.24a3 3 0 004.24 0l8.44-8.44a3 3 0 000-4.24L16.24 3.56zM14 21h7v-2h-7v2z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Timeline Body (Split Layout) -->
                <div class="timeline-body">
                    <!-- Left Panel: Track Headers -->
                    <div class="track-headers-panel" id="trackHeadersPanel">
                        <!-- Time Ruler Header -->
                        <div class="time-ruler">
                            <div class="time-ruler-header">
                                <button class="expand-tracks-btn" onclick="toggleAllTracksExpand()" title="Expand/Collapse Track Controls">
                                    <div class="expand-bar"></div>
                                    <div class="expand-bar"></div>
                                    <div class="expand-bar"></div>
                                    <div class="expand-arrow"></div>
                                </button>
                            </div>
                        </div>

                        <!-- Track Headers List -->
                        <div class="track-headers-list">
                            <!-- Chord Track Header -->
                            <div class="track-header-row">
                                <div class="track-header-box">
                                    <div class="track-color-bar chord"></div>
                                    <span class="track-name">Chord</span>
                                    <div class="track-controls">
                                        <div class="track-knob-group">
                                            <div class="track-knob volume"></div>
                                            <span class="track-knob-label">Vol</span>
                                        </div>
                                        <div class="track-knob-group">
                                            <div class="track-knob pan"></div>
                                            <span class="track-knob-label">Pan</span>
                                        </div>
                                        <button class="track-btn mute">M</button>
                                        <button class="track-btn solo">S</button>
                                        <button class="track-btn rec">R</button>
                                    </div>
                                    <div class="track-menu">
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Drums Header -->
                            <div class="track-header-row">
                                <div class="track-header-box selected">
                                    <div class="track-color-bar drums"></div>
                                    <span class="track-name">Drums</span>
                                    <div class="track-controls">
                                        <!-- Volume Knob -->
                                        <div class="track-knob-group">
                                            <div class="track-knob volume"></div>
                                            <span class="track-knob-label">Vol</span>
                                        </div>
                                        <!-- Pan Knob -->
                                        <div class="track-knob-group">
                                            <div class="track-knob pan"></div>
                                            <span class="track-knob-label">Pan</span>
                                        </div>
                                        <!-- Control Buttons -->
                                        <button class="track-btn mute">M</button>
                                        <button class="track-btn solo active">S</button>
                                        <button class="track-btn rec">R</button>
                                    </div>
                                    <div class="track-menu">
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bass Header -->
                            <div class="track-header-row">
                                <div class="track-header-box">
                                    <div class="track-color-bar bass"></div>
                                    <span class="track-name">Bass</span>
                                    <div class="track-controls">
                                        <div class="track-knob-group">
                                            <div class="track-knob volume"></div>
                                            <span class="track-knob-label">Vol</span>
                                        </div>
                                        <div class="track-knob-group">
                                            <div class="track-knob pan"></div>
                                            <span class="track-knob-label">Pan</span>
                                        </div>
                                        <button class="track-btn mute">M</button>
                                        <button class="track-btn solo">S</button>
                                        <button class="track-btn rec">R</button>
                                    </div>
                                    <div class="track-menu">
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Piano Header -->
                            <div class="track-header-row">
                                <div class="track-header-box">
                                    <div class="track-color-bar piano"></div>
                                    <span class="track-name">Piano</span>
                                    <div class="track-controls">
                                        <div class="track-knob-group">
                                            <div class="track-knob volume"></div>
                                            <span class="track-knob-label">Vol</span>
                                        </div>
                                        <div class="track-knob-group">
                                            <div class="track-knob pan"></div>
                                            <span class="track-knob-label">Pan</span>
                                        </div>
                                        <button class="track-btn mute">M</button>
                                        <button class="track-btn solo">S</button>
                                        <button class="track-btn rec">R</button>
                                    </div>
                                    <div class="track-menu">
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vocal Header -->
                            <div class="track-header-row">
                                <div class="track-header-box">
                                    <div class="track-color-bar vocal"></div>
                                    <span class="track-name">Vocal</span>
                                    <div class="track-controls">
                                        <div class="track-knob-group">
                                            <div class="track-knob volume"></div>
                                            <span class="track-knob-label">Vol</span>
                                        </div>
                                        <div class="track-knob-group">
                                            <div class="track-knob pan"></div>
                                            <span class="track-knob-label">Pan</span>
                                        </div>
                                        <button class="track-btn mute">M</button>
                                        <button class="track-btn solo">S</button>
                                        <button class="track-btn rec">R</button>
                                    </div>
                                    <div class="track-menu">
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                        <div class="track-menu-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resize Divider -->
                    <div class="timeline-divider" id="timelineDivider"></div>

                    <!-- Right Panel: Track Content -->
                    <div class="track-content-panel">
                        <!-- Time Ruler Content (100px = 1 bar, 25px = 1 beat) -->
                        <div class="time-ruler">
                            <div class="time-ruler-content" id="timeRulerContent">
                                <!-- Generated dynamically by JavaScript -->
                            </div>
                        </div>

                        <!-- Track Content List -->
                        <div class="track-content-list">
                            <!-- Playhead -->
                            <div class="playhead" style="left: 0px;"></div>

                            <!-- Chord Track Content -->
                            <div class="track-content-row chord-track-content">
                                <div class="chord-block" style="left: 10px; width: 100px;">Am7</div>
                                <div class="chord-block selected" style="left: 165px; width: 100px;">D7</div>
                                <div class="chord-block" style="left: 320px; width: 180px;">Gmaj7</div>
                                <div class="chord-block" style="left: 510px; width: 190px;">Cmaj7</div>
                            </div>

                            <!-- Drums Content -->
                            <div class="track-content-row">
                                <div class="track-region drums-region" style="left: 50px; width: 150px;">
                                    <span class="region-label">Drums</span>
                                    <div class="drum-pattern">
                                        <div class="drum-hit" style="height: 12px;"></div>
                                        <div class="drum-hit" style="height: 18px;"></div>
                                        <div class="drum-hit" style="height: 8px;"></div>
                                        <div class="drum-hit" style="height: 15px;"></div>
                                        <div class="drum-hit" style="height: 12px;"></div>
                                        <div class="drum-hit" style="height: 18px;"></div>
                                        <div class="drum-hit" style="height: 10px;"></div>
                                        <div class="drum-hit" style="height: 14px;"></div>
                                    </div>
                                </div>
                                <div class="track-region drums-region" style="left: 210px; width: 30px;"></div>
                                <div class="track-region drums-region" style="left: 250px; width: 30px;"></div>
                                <div class="track-region drums-region" style="left: 290px; width: 30px;"></div>
                                <div class="track-region drums-region" style="left: 330px; width: 30px;"></div>
                                <div class="track-region drums-region selected" style="left: 400px; width: 120px;">
                                    <span class="region-label">Drums</span>
                                    <div class="drum-pattern">
                                        <div class="drum-hit" style="height: 10px;"></div>
                                        <div class="drum-hit" style="height: 16px;"></div>
                                        <div class="drum-hit" style="height: 12px;"></div>
                                        <div class="drum-hit" style="height: 14px;"></div>
                                        <div class="drum-hit" style="height: 18px;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bass Content -->
                            <div class="track-content-row">
                                <div class="track-region bass-region selected" style="left: 100px; width: 130px;">
                                    <span class="region-label">Bass</span>
                                    <div class="waveform">
                                        <div class="wave-bar" style="height: 8px;"></div>
                                        <div class="wave-bar" style="height: 12px;"></div>
                                        <div class="wave-bar" style="height: 6px;"></div>
                                        <div class="wave-bar" style="height: 14px;"></div>
                                        <div class="wave-bar" style="height: 10px;"></div>
                                        <div class="wave-bar" style="height: 8px;"></div>
                                        <div class="wave-bar" style="height: 12px;"></div>
                                    </div>
                                </div>
                                <div class="track-region bass-region" style="left: 250px; width: 100px;">
                                    <span class="region-label">Bass</span>
                                    <div class="waveform">
                                        <div class="wave-bar" style="height: 10px;"></div>
                                        <div class="wave-bar" style="height: 14px;"></div>
                                        <div class="wave-bar" style="height: 8px;"></div>
                                        <div class="wave-bar" style="height: 12px;"></div>
                                    </div>
                                </div>
                                <div class="track-region bass-region" style="left: 370px; width: 150px;">
                                    <span class="region-label">Bass</span>
                                    <div class="waveform">
                                        <div class="wave-bar" style="height: 6px;"></div>
                                        <div class="wave-bar" style="height: 10px;"></div>
                                        <div class="wave-bar" style="height: 14px;"></div>
                                        <div class="wave-bar" style="height: 8px;"></div>
                                        <div class="wave-bar" style="height: 12px;"></div>
                                        <div class="wave-bar" style="height: 10px;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Piano Content -->
                            <div class="track-content-row">
                                <div class="track-region piano-region selected" style="left: 165px; width: 160px;">
                                    <span class="region-label">Piano</span>
                                    <div class="waveform">
                                        <div class="wave-bar" style="height: 4px;"></div>
                                        <div class="wave-bar" style="height: 8px;"></div>
                                        <div class="wave-bar" style="height: 6px;"></div>
                                        <div class="wave-bar" style="height: 10px;"></div>
                                        <div class="wave-bar" style="height: 4px;"></div>
                                        <div class="wave-bar" style="height: 8px;"></div>
                                    </div>
                                </div>
                                <div class="track-region piano-region" style="left: 400px; width: 120px;">
                                    <span class="region-label">Piano</span>
                                    <div class="waveform">
                                        <div class="wave-bar" style="height: 6px;"></div>
                                        <div class="wave-bar" style="height: 10px;"></div>
                                        <div class="wave-bar" style="height: 8px;"></div>
                                        <div class="wave-bar" style="height: 12px;"></div>
                                    </div>
                                </div>
                                <div class="auto-fill-region" style="left: 530px; width: 100px;">
                                    <div class="auto-fill-label">
                                        <span class="auto-fill-arrow">→</span>
                                        <span>Auto-fill</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Vocal Content -->
                            <div class="track-content-row">
                                <div class="track-region vocal-region selected" style="left: 540px; width: 130px;">
                                    <span class="region-label">Vocal</span>
                                    <div class="vocal-circle"></div>
                                    <div class="vocal-waveform" style="left: 40px;">
                                        <div class="vocal-wave" style="height: 4px;"></div>
                                        <div class="vocal-wave" style="height: 8px;"></div>
                                        <div class="vocal-wave" style="height: 12px;"></div>
                                        <div class="vocal-wave" style="height: 6px;"></div>
                                        <div class="vocal-wave" style="height: 10px;"></div>
                                        <div class="vocal-wave" style="height: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Scrollbar Area -->
                        <div class="timeline-scroll-area">
                            <div class="timeline-scroll">
                                <div class="timeline-scroll-thumb"></div>
                            </div>
                            <div class="scroll-corner"></div>
                        </div>
                    </div>

                    <!-- Vertical Scrollbar (Right side) -->
                    <div class="timeline-vertical-scroll">
                        <div class="vertical-scroll-track">
                            <div class="vertical-scroll-thumb"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Detail Editor - Cubase Style Piano Roll -->
            <section class="detail-editor">
                <div class="detail-editor-header">
                    <span class="detail-editor-title">Edit Dock</span>
                    <div class="edit-dock-tabs">
                        <button class="edit-dock-tab active">Step Seq</button>
                        <button class="edit-dock-tab">Piano Roll</button>
                        <button class="edit-dock-tab">Mixer</button>
                        <button class="edit-dock-tab">Audio</button>
                        <button class="edit-dock-tab">Sampler</button>
                    </div>
                </div>
                <!-- Tab Panels -->
                <!-- Step Seq Panel -->
                <div class="edit-dock-panel active" data-panel="step-seq">
                    <div class="step-seq-wrapper">
                        <div class="step-seq-container">
                            <!-- Left - Track Headers -->
                            <div class="step-seq-tracks">
                            <!-- Add Track Button (위쪽) -->
                            <div class="step-seq-add-track" title="Add Track">
                                <span class="add-icon">+</span>
                            </div>
                            <!-- Kick Track -->
                            <div class="step-seq-track-header" data-track="kick">
                                <div class="smart-rand-btn" title="Smart Randomize">
                                    <svg viewBox="0 0 24 24" class="dice-icon">
                                        <rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                                    </svg>
                                    <span class="smart-rand-label">Smart Rand</span>
                                </div>
                                <span class="step-seq-track-name" style="color: #FF6B6B;">Kick</span>
                            </div>
                            <!-- Snare Track -->
                            <div class="step-seq-track-header" data-track="snare">
                                <div class="smart-rand-btn" title="Smart Randomize">
                                    <svg viewBox="0 0 24 24" class="dice-icon">
                                        <rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                                    </svg>
                                    <span class="smart-rand-label">Smart Rand</span>
                                </div>
                                <span class="step-seq-track-name" style="color: #4DFFFF;">Snare</span>
                            </div>
                            <!-- Hi-Hat Track -->
                            <div class="step-seq-track-header" data-track="hihat">
                                <div class="smart-rand-btn" title="Smart Randomize">
                                    <svg viewBox="0 0 24 24" class="dice-icon">
                                        <rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                                    </svg>
                                    <span class="smart-rand-label">Smart Rand</span>
                                </div>
                                <span class="step-seq-track-name" style="color: #4FD272;">Hi-Hat Closed</span>
                            </div>
                            <!-- Perc Track -->
                            <div class="step-seq-track-header" data-track="perc">
                                <div class="smart-rand-btn" title="Smart Randomize">
                                    <svg viewBox="0 0 24 24" class="dice-icon">
                                        <rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                                    </svg>
                                    <span class="smart-rand-label">Smart Rand</span>
                                </div>
                                <span class="step-seq-track-name" style="color: #D45FFF;">Perc</span>
                            </div>
                        </div>

                        <!-- Center - 16 Step Grid -->
                        <div class="step-seq-grid-area">
                            <!-- Beat Ruler with tick marks -->
                            <div class="step-seq-ruler">
                                <!-- Beat 1 -->
                                <div class="step-seq-ruler-beat">
                                    <div class="ruler-tick"><span class="beat-label">1</span></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                </div>
                                <!-- Beat 2 -->
                                <div class="step-seq-ruler-beat">
                                    <div class="ruler-tick"><span class="beat-label">2</span></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                </div>
                                <!-- Beat 3 -->
                                <div class="step-seq-ruler-beat">
                                    <div class="ruler-tick"><span class="beat-label">3</span></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                </div>
                                <!-- Beat 4 -->
                                <div class="step-seq-ruler-beat">
                                    <div class="ruler-tick"><span class="beat-label">4</span></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                    <div class="ruler-tick"></div>
                                </div>
                            </div>
                            <!-- Grid Rows with scroll container -->
                            <div class="step-seq-grid-scroll">
                                <!-- Wave Visualizer - SVG Fluid Wave -->
                                <div class="wave-visualizer" id="waveVisualizer">
                                    <svg id="wave-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                                        <defs>
                                            <linearGradient id="wave-fill-gradient" x1="0%" y1="100%" x2="0%" y2="0%">
                                                <stop offset="0%" style="stop-color:rgba(255,255,255,0); stop-opacity:0" />
                                                <stop offset="100%" style="stop-color:rgba(255,255,255,0.4); stop-opacity:0.4" />
                                            </linearGradient>
                                        </defs>
                                        <path id="wave-path" d="M0 100 L100 100" fill="url(#wave-fill-gradient)" stroke="rgba(255,255,255,0.8)" stroke-width="0.3" />
                                    </svg>
                                </div>
                                <div class="step-seq-grid">
                                    <!-- Kick Row: 1, 5, 9, 13박 (기본 4비트) -->
                                    <div class="step-seq-row" data-track="kick" data-color="#FF6B6B">
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="0"></div>
                                            <div class="step-cell" data-step="1"></div>
                                            <div class="step-cell" data-step="2"></div>
                                            <div class="step-cell" data-step="3"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="4"></div>
                                            <div class="step-cell" data-step="5"></div>
                                            <div class="step-cell" data-step="6"></div>
                                            <div class="step-cell" data-step="7"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="8"></div>
                                            <div class="step-cell" data-step="9"></div>
                                            <div class="step-cell" data-step="10"></div>
                                            <div class="step-cell" data-step="11"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="12"></div>
                                            <div class="step-cell" data-step="13"></div>
                                            <div class="step-cell" data-step="14"></div>
                                            <div class="step-cell" data-step="15"></div>
                                        </div>
                                    </div>
                                    <!-- Snare Row: 5, 13박 (2, 4박 백비트) -->
                                    <div class="step-seq-row" data-track="snare" data-color="#4DFFFF">
                                        <div class="step-beat-group">
                                            <div class="step-cell" data-step="0"></div>
                                            <div class="step-cell" data-step="1"></div>
                                            <div class="step-cell" data-step="2"></div>
                                            <div class="step-cell" data-step="3"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="4"></div>
                                            <div class="step-cell" data-step="5"></div>
                                            <div class="step-cell" data-step="6"></div>
                                            <div class="step-cell" data-step="7"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell" data-step="8"></div>
                                            <div class="step-cell" data-step="9"></div>
                                            <div class="step-cell" data-step="10"></div>
                                            <div class="step-cell" data-step="11"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="12"></div>
                                            <div class="step-cell" data-step="13"></div>
                                            <div class="step-cell" data-step="14"></div>
                                            <div class="step-cell" data-step="15"></div>
                                        </div>
                                    </div>
                                    <!-- Hi-Hat Row: 8비트 (짝수 스텝마다) -->
                                    <div class="step-seq-row" data-track="hihat" data-color="#4FD272">
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="0"></div>
                                            <div class="step-cell" data-step="1"></div>
                                            <div class="step-cell active" data-step="2"></div>
                                            <div class="step-cell" data-step="3"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="4"></div>
                                            <div class="step-cell" data-step="5"></div>
                                            <div class="step-cell active" data-step="6"></div>
                                            <div class="step-cell" data-step="7"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="8"></div>
                                            <div class="step-cell" data-step="9"></div>
                                            <div class="step-cell active" data-step="10"></div>
                                            <div class="step-cell" data-step="11"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell active" data-step="12"></div>
                                            <div class="step-cell" data-step="13"></div>
                                            <div class="step-cell active" data-step="14"></div>
                                            <div class="step-cell" data-step="15"></div>
                                        </div>
                                    </div>
                                    <!-- Perc Row: 비어있음 (사용자가 추가) -->
                                    <div class="step-seq-row" data-track="perc" data-color="#D45FFF">
                                        <div class="step-beat-group">
                                            <div class="step-cell" data-step="0"></div>
                                            <div class="step-cell" data-step="1"></div>
                                            <div class="step-cell" data-step="2"></div>
                                            <div class="step-cell" data-step="3"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell" data-step="4"></div>
                                            <div class="step-cell" data-step="5"></div>
                                            <div class="step-cell" data-step="6"></div>
                                            <div class="step-cell" data-step="7"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell" data-step="8"></div>
                                            <div class="step-cell" data-step="9"></div>
                                            <div class="step-cell" data-step="10"></div>
                                            <div class="step-cell" data-step="11"></div>
                                        </div>
                                        <div class="step-beat-group">
                                            <div class="step-cell" data-step="12"></div>
                                            <div class="step-cell" data-step="13"></div>
                                            <div class="step-cell active" data-step="14"></div>
                                            <div class="step-cell" data-step="15"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right - Control Panel -->
                        <div class="step-seq-controls">
                            <div class="kit-morph-btn" title="Kit Morph">
                                <svg viewBox="0 0 24 24" class="morph-icon">
                                    <path d="M17 1l4 4-4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 11V9a4 4 0 014-4h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                                    <path d="M7 23l-4-4 4-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                                </svg>
                                <span class="kit-morph-label">Kit Morph</span>
                            </div>
                            <div class="humanize-control">
                                <span class="humanize-label">Humanize</span>
                                <div class="humanize-slider-container">
                                    <div class="humanize-slider-track">
                                        <div class="humanize-slider-fill" style="height: 35%;"></div>
                                    </div>
                                    <span class="humanize-value">35%</span>
                                </div>
                            </div>
                            <div class="step-count-toggle" title="Toggle 16/32 Steps">
                                <span class="step-count-value">32</span>
                                <span class="step-count-label">Steps</span>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Piano Roll Panel -->
                <div class="edit-dock-panel" data-panel="piano-roll">
                <div class="editor-content">
                    <!-- AI Modifier Panel -->
                    <div class="ai-modifier">
                        <div class="modifier-title">AI Modifier</div>
                        <div class="slider-group">
                            <div class="slider-label">Rhythm</div>
                            <div class="slider-bar">
                                <div class="slider-fill" style="width: 70%;"></div>
                            </div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">Velocity</div>
                            <div class="slider-bar">
                                <div class="slider-fill" style="width: 50%;"></div>
                            </div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">Humanize</div>
                            <div class="slider-bar">
                                <div class="slider-fill" style="width: 30%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Piano Roll -->
                    <div class="piano-roll">
                        <!-- Time Ruler -->
                        <div class="piano-roll-ruler">
                            <div class="piano-roll-ruler-corner">
                                <span class="midi-clip-name">MIDI 02</span>
                            </div>
                            <div class="piano-roll-ruler-content" id="pianoRollRuler">
                                <!-- Generated by JS -->
                            </div>
                        </div>

                        <!-- Piano Roll Body -->
                        <div class="piano-roll-body">
                            <!-- Piano Keys -->
                            <div class="piano-keys" id="pianoKeys">
                                <!-- Generated by JS -->
                            </div>

                            <!-- MIDI Grid Container -->
                            <div class="midi-grid-container">
                                <div class="midi-grid" id="midiGrid">
                                    <!-- Grid background rows -->
                                    <div class="midi-grid-rows" id="midiGridRows">
                                        <!-- Generated by JS -->
                                    </div>
                                    <!-- Grid lines overlay -->
                                    <div class="midi-grid-lines"></div>
                                    <!-- Playhead -->
                                    <div class="piano-roll-playhead" style="left: 0px;"></div>
                                    <!-- MIDI Notes - positioned by JS -->
                                    <div id="midiNotes">
                                        <!-- Generated by JS -->
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Velocity Section - Cubase Style (Full Width Below) -->
                        <div class="velocity-section">
                            <div class="velocity-lane">
                                <div class="velocity-header">
                                    <div class="velocity-label-area">Velocity</div>
                                </div>
                                <div class="velocity-grid" id="velocityGrid">
                                    <!-- Velocity bars generated by JS -->
                                </div>
                                <div class="velocity-max-label">127</div>
                            </div>
                            <div class="velocity-bottom-bar">
                                <div class="velocity-controls-left">
                                    <div class="velocity-add-btn">+</div>
                                    <div class="velocity-dropdown-btn">▼</div>
                                </div>
                                <div class="piano-roll-scrollbar">
                                    <div class="piano-roll-scroll-track">
                                        <div class="piano-roll-scroll-thumb"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Mixer Panel (FL Studio Style) -->
                <div class="edit-dock-panel" data-panel="mixer">
                    <div class="mixer-wrapper">
                        <div class="mixer-content">
                            <!-- Kick Channel -->
                            <div class="channel-strip" style="--fader-color: #FF6B6B; --knob-color: #FF6B6B;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #FF6B6B; box-shadow: 0 0 8px #FF6B6B;"></div>
                                    <div class="mixer-track-name-vertical">Kick</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob active" style="--knob-rotation: 45deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">65%</div>
                                    </div>
                                    <div class="smart-knob-label">Punch</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 75%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 70%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 72%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-3.2</div>
                            </div>

                            <!-- Snare Channel -->
                            <div class="channel-strip" style="--fader-color: #4DFFFF; --knob-color: #4DFFFF;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #4DFFFF; box-shadow: 0 0 8px #4DFFFF;"></div>
                                    <div class="mixer-track-name-vertical">Snare</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob" style="--knob-rotation: 30deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">50%</div>
                                    </div>
                                    <div class="smart-knob-label">Crack</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 55%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 60%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 52%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-6.0</div>
                            </div>

                            <!-- Hi-Hat Channel -->
                            <div class="channel-strip" style="--fader-color: #4FD272; --knob-color: #4FD272;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #4FD272; box-shadow: 0 0 8px #4FD272;"></div>
                                    <div class="mixer-track-name-vertical">Hi-Hat</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl active-solo">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob active" style="--knob-rotation: 60deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">72%</div>
                                    </div>
                                    <div class="smart-knob-label">Crisp</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 45%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 50%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 42%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-8.5</div>
                            </div>

                            <!-- Perc Channel -->
                            <div class="channel-strip" style="--fader-color: #D45FFF; --knob-color: #D45FFF;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #D45FFF; box-shadow: 0 0 8px #D45FFF;"></div>
                                    <div class="mixer-track-name-vertical">Perc</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl active-mute">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob" style="--knob-rotation: -45deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">25%</div>
                                    </div>
                                    <div class="smart-knob-label">Body</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 0%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 5%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 0%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-∞</div>
                            </div>

                            <!-- Bass Channel -->
                            <div class="channel-strip" style="--fader-color: #F39C12; --knob-color: #F39C12;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #F39C12; box-shadow: 0 0 8px #F39C12;"></div>
                                    <div class="mixer-track-name-vertical">Bass</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob active" style="--knob-rotation: 75deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">80%</div>
                                    </div>
                                    <div class="smart-knob-label">Grit</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 68%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 65%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 65%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-4.2</div>
                            </div>

                            <!-- Piano Channel -->
                            <div class="channel-strip" style="--fader-color: #5DADE2; --knob-color: #5DADE2;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #5DADE2; box-shadow: 0 0 8px #5DADE2;"></div>
                                    <div class="mixer-track-name-vertical">Piano</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob" style="--knob-rotation: 20deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">40%</div>
                                    </div>
                                    <div class="smart-knob-label">Space</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 58%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 55%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 55%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-4.8</div>
                            </div>

                            <!-- Vocal Channel -->
                            <div class="channel-strip" style="--fader-color: #9B59B6; --knob-color: #9B59B6;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #9B59B6; box-shadow: 0 0 8px #9B59B6;"></div>
                                    <div class="mixer-track-name-vertical">Vocal</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob active" style="--knob-rotation: 55deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">68%</div>
                                    </div>
                                    <div class="smart-knob-label">Air</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 82%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 78%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 80%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-1.5</div>
                            </div>

                            <!-- Separator -->
                            <div class="mixer-separator"></div>

                            <!-- FX Channel -->
                            <div class="channel-strip fx-strip" style="--fader-color: #FF6B9D; --knob-color: #FF6B9D;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #FF6B9D; box-shadow: 0 0 8px #FF6B9D;"></div>
                                    <div class="mixer-track-name-vertical">FX</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob" style="--knob-rotation: 35deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">55%</div>
                                    </div>
                                    <div class="smart-knob-label">Send</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 45%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 50%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 42%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-6.0</div>
                            </div>

                            <!-- Group Channel -->
                            <div class="channel-strip group-strip" style="--fader-color: #00BFFF; --knob-color: #00BFFF;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #00BFFF; box-shadow: 0 0 8px #00BFFF;"></div>
                                    <div class="mixer-track-name-vertical">Group</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob active" style="--knob-rotation: 50deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">62%</div>
                                    </div>
                                    <div class="smart-knob-label">Blend</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 72%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 70%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 68%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-2.5</div>
                            </div>

                            <!-- Separator 2 -->
                            <div class="mixer-separator"></div>

                            <!-- Master Channel -->
                            <div class="channel-strip master-strip" style="--fader-color: #FFD700; --knob-color: #FFD700;">
                                <div class="mixer-track-header">
                                    <div class="mixer-color-bar" style="background: #FFD700; box-shadow: 0 0 12px #FFD700;"></div>
                                    <div class="mixer-track-name-vertical">Master</div>
                                </div>
                                <div class="mixer-controls-row">
                                    <button class="btn-mixer-ctrl">M</button>
                                    <button class="btn-mixer-ctrl">S</button>
                                </div>
                                <div class="smart-knob-wrapper">
                                    <div class="smart-knob active" style="--knob-rotation: 40deg;">
                                        <div class="smart-knob-indicator"></div>
                                        <div class="smart-knob-value">58%</div>
                                    </div>
                                    <div class="smart-knob-label">Loud</div>
                                </div>
                                <div class="mixer-fader-section">
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 88%;"></div></div>
                                    <div class="mixer-fader-track">
                                        <div class="mixer-fader-thumb" style="bottom: 85%;"></div>
                                    </div>
                                    <div class="level-meter"><div class="level-meter-fill" style="height: 86%;"></div></div>
                                </div>
                                <div class="mixer-vol-display">-0.1</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio Panel -->
                <div class="edit-dock-panel" data-panel="audio">
                    <div class="empty-panel-placeholder">Audio Editor</div>
                </div>

                <!-- Sampler Panel -->
                <div class="edit-dock-panel" data-panel="sampler">
                    <div class="empty-panel-placeholder">Sampler</div>
                </div>
            </section>
        </main>

        <!-- AI Copilot -->
        <aside class="ai-copilot">
            <div class="copilot-title">AI Copilot</div>
            <div class="chat-container">
                <div class="chat-bubble user">
                    <div class="chat-sender">User:</div>
                    <div>Make the drums quieter.</div>
                </div>
                <div class="chat-bubble ai">
                    <div class="chat-sender">AI:</div>
                    <div>Done. Adjusted volume by -3dB.</div>
                </div>
                <div class="chat-bubble user">
                    <div class="chat-sender">User:</div>
                    <div>Add reverb to the piano.</div>
                </div>
                <div class="chat-bubble ai">
                    <div class="chat-sender">AI:</div>
                    <div>Added Hall Reverb with 30% wet mix.</div>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" placeholder="Type a command...">
                <button class="send-btn">></button>
            </div>
        </aside>
    </div>

    <script>
        // ============================================
        // Edit Dock Focus System & Step Sequencer
        // ============================================
        (function() {
            // 현재 포커스된 에디터 (step-seq, piano-roll, mixer, audio, sampler)
            let focusedEditor = 'step-seq';
            const panelNames = ['step-seq', 'piano-roll', 'mixer', 'audio', 'sampler'];

            // Edit Dock Tab Switching with Focus
            document.querySelectorAll('.edit-dock-tab').forEach((tab, index) => {
                tab.addEventListener('click', function() {
                    // Remove active from all tabs
                    document.querySelectorAll('.edit-dock-tab').forEach(t => {
                        t.classList.remove('active');
                        t.classList.remove('focused');
                    });
                    // Add active and focused to clicked tab
                    this.classList.add('active');
                    this.classList.add('focused');

                    // Hide all panels
                    document.querySelectorAll('.edit-dock-panel').forEach(p => p.classList.remove('active'));
                    // Show corresponding panel
                    const panels = document.querySelectorAll('.edit-dock-panel');
                    if (panels[index]) {
                        panels[index].classList.add('active');
                    }

                    // Update focused editor
                    focusedEditor = panelNames[index] || 'step-seq';
                    console.log('Focused editor:', focusedEditor);
                });
            });

            // ============================================
            // Step Sequencer Drum Sounds (Tone.js)
            // ============================================
            let kickSynth = null;
            let snareSynth = null;
            let hihatSynth = null;
            let percSynth = null;
            let stepSeqScheduleId = null;
            let isStepSeqPlaying = false;
            let currentStep = 0;
            const TOTAL_STEPS = 16;

            // [메모리 기반] 패턴 상태 저장 - 각 스텝마다 독립 객체 생성!
            let sequenceData = {
                kick: Array.from({ length: 16 }, () => ({ active: false, ratchet: 0 })),
                snare: Array.from({ length: 16 }, () => ({ active: false, ratchet: 0 })),
                hihat: Array.from({ length: 16 }, () => ({ active: false, ratchet: 0 })),
                perc: Array.from({ length: 16 }, () => ({ active: false, ratchet: 0 }))
            };

            // [초기화] DOM에서 현재 상태를 읽어 sequenceData 동기화
            function syncStateFromDOM() {
                // 1. 모든 트랙 초기화 (독립 객체로)
                ['kick', 'snare', 'hihat', 'perc'].forEach(track => {
                    sequenceData[track] = Array.from({ length: 16 }, () => ({ active: false, ratchet: 0 }));
                });

                // 2. DOM에서 활성화된 셀만 업데이트
                document.querySelectorAll('.step-seq-row').forEach(row => {
                    const track = row.dataset.track;
                    if (!sequenceData[track]) return;

                    row.querySelectorAll('.step-cell').forEach(cell => {
                        const step = parseInt(cell.dataset.step);
                        if (isNaN(step) || step < 0 || step >= 16) return;

                        sequenceData[track][step].active = cell.classList.contains('active');
                        sequenceData[track][step].ratchet = parseInt(cell.dataset.ratchet) || 0;
                    });
                });
                // 디버그: 래칫이 있는 셀 출력
                const ratchetCells = [];
                ['kick', 'snare', 'hihat', 'perc'].forEach(track => {
                    sequenceData[track].forEach((step, idx) => {
                        if (step.ratchet >= 2) {
                            ratchetCells.push(`${track}:${idx}=x${step.ratchet}`);
                        }
                    });
                });
                console.log('[Step Seq] ✅ Memory & DOM Synced! Ratchets:', ratchetCells.join(', ') || 'none');
            }

            // [메모리 업데이트] 셀 상태 변경 시 호출
            function updateSequenceCell(track, stepIndex, active, ratchet = 0) {
                if (sequenceData[track] && stepIndex >= 0 && stepIndex < TOTAL_STEPS) {
                    sequenceData[track][stepIndex] = { active, ratchet };
                }
            }

            // 드럼 사운드 초기화
            function initDrumSounds() {
                if (typeof Tone === 'undefined') return;
                if (kickSynth) return;  // 이미 초기화됨

                // Kick - MembraneSynth (깊은 저음)
                kickSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 6,
                    oscillator: { type: 'sine' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.4,
                        sustain: 0.01,
                        release: 0.4
                    }
                }).toDestination();
                kickSynth.volume.value = -6;

                // Snare - NoiseSynth + MembraneSynth 레이어
                snareSynth = new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.15,
                        sustain: 0,
                        release: 0.1
                    }
                }).toDestination();
                snareSynth.volume.value = -10;

                // HiHat - NoiseSynth + HighPass Filter (깨끗한 하이햇)
                const hihatFilter = new Tone.Filter({
                    frequency: 8000,
                    type: 'highpass',
                    rolloff: -12
                }).toDestination();

                hihatSynth = new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.08,
                        sustain: 0,
                        release: 0.03
                    }
                }).connect(hihatFilter);
                hihatSynth.volume.value = -8;

                // Perc - MembraneSynth (높은 피치)
                percSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.01,
                    octaves: 4,
                    oscillator: { type: 'sine' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.1,
                        sustain: 0,
                        release: 0.1
                    }
                }).toDestination();
                percSynth.volume.value = -8;

                // 전역 접근용 (Smart Kit Morph에서 사용)
                window.auraDrumSynths = {
                    kick: kickSynth,
                    snare: snareSynth,
                    hihat: hihatSynth,
                    perc: percSynth
                };

                console.log('AURA Drum Sounds initialized');
            }

            // ============================================
            // Fluid Wave Visualizer (SVG Path)
            // ============================================

            const WAVE_POINTS = 24;  // 파형 포인트 수
            const waveHeights = new Array(WAVE_POINTS).fill(0);
            let waveAnimationId = null;
            let isWavePlaying = false;

            // 웨이브 시작
            function startWaveVisualizer() {
                if (isWavePlaying) return;
                isWavePlaying = true;
                document.getElementById('waveVisualizer')?.classList.add('playing');
                animateWave();
            }

            // 웨이브 정지
            function stopWaveVisualizer() {
                isWavePlaying = false;
                if (waveAnimationId) {
                    cancelAnimationFrame(waveAnimationId);
                    waveAnimationId = null;
                }
                // 파형 리셋
                waveHeights.fill(0);
                const path = document.getElementById('wave-path');
                if (path) path.setAttribute('d', 'M0 100 L100 100 Z');
                document.getElementById('waveVisualizer')?.classList.remove('playing');
            }

            // 드럼 트리거 → 특정 위치 솟구치기
            function triggerWaveVisual(track) {
                let centerIndex, intensity, width;

                switch(track) {
                    case 'kick':
                        // 왼쪽 (저음부) - 넓고 강하게
                        centerIndex = 4;
                        intensity = 75;
                        width = 5;
                        break;
                    case 'snare':
                        // 중앙 - 넓게
                        centerIndex = 12;
                        intensity = 60;
                        width = 6;
                        break;
                    case 'hihat':
                        // 오른쪽 (고음부) - 좁고 날카롭게
                        centerIndex = 19;
                        intensity = 40;
                        width = 3;
                        break;
                    case 'perc':
                        // 중간~오른쪽
                        centerIndex = 15;
                        intensity = 45;
                        width = 4;
                        break;
                    default:
                        return;
                }

                // Bell Curve 형태로 주변 포인트도 영향
                for (let i = 0; i < WAVE_POINTS; i++) {
                    const distance = Math.abs(i - centerIndex);
                    if (distance <= width) {
                        const factor = 1 - (distance / width);
                        const boost = intensity * factor * factor;  // 제곱으로 더 부드러운 곡선
                        waveHeights[i] = Math.min(85, Math.max(waveHeights[i], waveHeights[i] * 0.5 + boost));
                    }
                }
            }

            // 애니메이션 루프
            function animateWave() {
                const path = document.getElementById('wave-path');
                if (!path) {
                    if (isWavePlaying) waveAnimationId = requestAnimationFrame(animateWave);
                    return;
                }

                // 감쇠 (Decay)
                for (let i = 0; i < WAVE_POINTS; i++) {
                    waveHeights[i] *= 0.92;
                    if (waveHeights[i] < 0.5) waveHeights[i] = 0;
                }

                // SVG Path 생성 (부드러운 곡선)
                const stepX = 100 / (WAVE_POINTS - 1);
                let d = 'M 0 100 ';  // 시작 (왼쪽 아래)

                // 첫 점으로 이동
                d += `L 0 ${100 - waveHeights[0]} `;

                // Smooth Quadratic Bezier로 연결
                for (let i = 0; i < WAVE_POINTS - 1; i++) {
                    const x0 = i * stepX;
                    const x1 = (i + 1) * stepX;
                    const y0 = 100 - waveHeights[i];
                    const y1 = 100 - waveHeights[i + 1];

                    // 중간점으로 부드럽게
                    const midX = (x0 + x1) / 2;
                    const midY = (y0 + y1) / 2;

                    d += `Q ${x0} ${y0}, ${midX} ${midY} `;
                }

                // 마지막 점
                d += `T 100 ${100 - waveHeights[WAVE_POINTS - 1]} `;

                // 바닥으로 닫기
                d += 'L 100 100 Z';

                path.setAttribute('d', d);

                // 다음 프레임
                if (isWavePlaying) {
                    waveAnimationId = requestAnimationFrame(animateWave);
                }
            }

            // 드럼 트리거 - 사운드 + 비주얼
            function triggerDrum(track, time) {
                try {
                    switch(track) {
                        case 'kick':
                            if (kickSynth) kickSynth.triggerAttackRelease('C1', '16n', time);
                            break;
                        case 'snare':
                            if (snareSynth) snareSynth.triggerAttackRelease('16n', time);
                            break;
                        case 'hihat':
                            if (hihatSynth) hihatSynth.triggerAttackRelease('32n', time);
                            break;
                        case 'perc':
                            if (percSynth) percSynth.triggerAttackRelease('G3', '16n', time);
                            break;
                    }
                    // 웨이브 비주얼 트리거 (메인 스레드에서 실행)
                    Tone.Draw.schedule(() => {
                        triggerWaveVisual(track);
                    }, time);
                } catch (e) {
                    // 에러 무시 (래칫 중복 트리거 시 발생 가능)
                }
            }

            // [메모리 기반] 패턴 데이터 반환 - DOM 접근 없음!
            function getPatternData() {
                return sequenceData;
            }

            // 현재 스텝 하이라이트
            function highlightCurrentStep(step) {
                // 이전 하이라이트 제거
                document.querySelectorAll('.step-cell.current').forEach(cell => {
                    cell.classList.remove('current');
                });

                // 새 하이라이트 추가
                document.querySelectorAll('.step-seq-row').forEach(row => {
                    const cells = row.querySelectorAll('.step-cell');
                    if (cells[step]) {
                        cells[step].classList.add('current');
                    }
                });
            }

            // Step Sequencer 재생 시작
            function startStepSequencer() {
                if (typeof Tone === 'undefined') return;
                if (isStepSeqPlaying) return;

                // ⭐ 안전장치: 시작 전 혹시 남은 예약 이벤트 제거
                Tone.Transport.cancel(0);

                initDrumSounds();
                syncStateFromDOM();  // [최초 1회] DOM → 메모리 동기화
                isStepSeqPlaying = true;
                currentStep = 0;

                // Transport 위치 리셋 (Step Seq는 독립적으로 0부터 시작)
                Tone.Transport.stop();
                Tone.Transport.position = 0;

                // 16분음표 단위로 스케줄링
                stepSeqScheduleId = Tone.Transport.scheduleRepeat((time) => {
                    if (!isStepSeqPlaying) return;

                    // 패턴 데이터 읽기
                    const pattern = getPatternData();

                    // 각 트랙의 현재 스텝 확인 및 재생
                    ['kick', 'snare', 'hihat', 'perc'].forEach(track => {
                        const stepData = pattern[track][currentStep];
                        if (stepData && stepData.active) {
                            // 래칫 처리
                            const ratchetCount = stepData.ratchet >= 2 ? stepData.ratchet : 1;

                            if (ratchetCount >= 2) {
                                // 래칫: 직접 시간 오프셋으로 트리거 (scheduleOnce 대신)
                                const ratchetInterval = Tone.Time('16n').toSeconds() / ratchetCount;
                                for (let i = 0; i < ratchetCount; i++) {
                                    triggerDrum(track, time + (ratchetInterval * i));
                                }
                            } else {
                                // 일반 노트
                                triggerDrum(track, time);
                            }
                        }
                    });

                    // UI 업데이트 (메인 스레드)
                    const stepToHighlight = currentStep;
                    Tone.Draw.schedule(() => {
                        highlightCurrentStep(stepToHighlight);
                    }, time);

                    // 다음 스텝
                    currentStep = (currentStep + 1) % TOTAL_STEPS;
                }, '16n', 0);

                // Transport 시작
                Tone.Transport.start();

                // 웨이브 비주얼라이저 시작
                startWaveVisualizer();

                console.log('Step Sequencer started');
            }

            // Step Sequencer 정지
            function stopStepSequencer() {
                if (!isStepSeqPlaying) return;

                isStepSeqPlaying = false;

                // 스케줄 제거
                if (stepSeqScheduleId !== null && typeof Tone !== 'undefined') {
                    Tone.Transport.clear(stepSeqScheduleId);
                    stepSeqScheduleId = null;
                }

                // Transport 정지
                if (typeof Tone !== 'undefined') {
                    Tone.Transport.stop();
                    Tone.Transport.position = 0;

                    // ⭐ 미래에 예약된 모든 이벤트 취소 (래칫 꼬임 방지)
                    Tone.Transport.cancel(0);
                }

                // 웨이브 비주얼라이저 정지
                stopWaveVisualizer();

                // 하이라이트 제거
                document.querySelectorAll('.step-cell.current').forEach(cell => {
                    cell.classList.remove('current');
                });

                currentStep = 0;
                console.log('Step Sequencer stopped');
            }

            // Step Sequencer 토글
            function toggleStepSequencer() {
                if (isStepSeqPlaying) {
                    stopStepSequencer();
                } else {
                    startStepSequencer();
                }
            }

            // 스페이스바 핸들링 - 포커스된 에디터에 따라 동작
            function handleSpacebarForEditor(e) {
                // 입력 필드에서는 무시
                if (e.target.matches('input, textarea')) return;
                if (e.code !== 'Space') return;

                // Step Seq 탭이 포커스된 경우
                if (focusedEditor === 'step-seq') {
                    e.preventDefault();
                    e.stopPropagation();

                    // Web Audio Context 활성화 (첫 클릭 정책)
                    if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                        Tone.start().then(() => {
                            toggleStepSequencer();
                        });
                    } else {
                        toggleStepSequencer();
                    }
                    return true;  // 처리됨
                }

                return false;  // 처리 안됨 (기본 Transport에서 처리)
            }

            // 스페이스바 이벤트 (우선순위 높게)
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                    // Step Seq가 포커스된 경우에만 처리
                    if (focusedEditor === 'step-seq') {
                        handleSpacebarForEditor(e);
                    }
                }
            }, true);  // capture phase에서 처리

            // 초기 포커스 설정
            const firstTab = document.querySelector('.edit-dock-tab');
            if (firstTab) {
                firstTab.classList.add('focused');
            }

            // ============================================
            // Pattern → Region 변환 준비
            // ============================================

            // 패턴을 Region 데이터로 내보내기
            function exportPatternAsRegion() {
                const pattern = getPatternData();
                const bpm = Tone?.Transport?.bpm?.value || 120;

                // 16스텝 = 1마디 (4/4 박자 기준, 16분음표)
                const regionData = {
                    id: 'pattern_' + Date.now(),
                    name: 'Step Pattern',
                    type: 'drum-pattern',
                    duration: '1:0:0',  // 1마디
                    bpm: bpm,
                    timeSignature: [4, 4],
                    tracks: pattern,
                    color: '#4DFFFF'
                };

                return regionData;
            }

            // 드래그 앤 드롭용 데이터 준비 (비활성화 - 클릭 이벤트와 충돌)
            // 패턴 드래그는 별도 드래그 핸들로 구현 예정
            let draggedPattern = null;

            // Timeline 드롭 영역 설정
            const trackViews = document.querySelectorAll('.track-view-content');
            trackViews.forEach(trackView => {
                trackView.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    this.style.background = 'rgba(77, 255, 255, 0.1)';
                });

                trackView.addEventListener('dragleave', function(e) {
                    this.style.background = '';
                });

                trackView.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.background = '';

                    const jsonData = e.dataTransfer.getData('application/json');
                    if (jsonData) {
                        try {
                            const regionData = JSON.parse(jsonData);
                            console.log('Pattern dropped on timeline:', regionData);

                            // 드롭 위치 계산 (픽셀 → 마디)
                            const rect = this.getBoundingClientRect();
                            const dropX = e.clientX - rect.left + this.scrollLeft;
                            const barPosition = Math.floor(dropX / 100);  // 100px per bar

                            // Region 생성 (실제 구현은 추후)
                            console.log('Create region at bar:', barPosition);

                            // 이벤트 발생 (다른 모듈에서 처리 가능)
                            const event = new CustomEvent('patternDropped', {
                                detail: {
                                    pattern: regionData,
                                    position: barPosition,
                                    trackElement: this
                                }
                            });
                            document.dispatchEvent(event);
                        } catch (err) {
                            console.error('Invalid pattern data:', err);
                        }
                    }
                });
            });

            // Step Sequencer 상태 확인용 전역 접근
            window.stepSeqState = {
                isPlaying: () => isStepSeqPlaying,
                toggle: toggleStepSequencer,
                start: startStepSequencer,
                stop: stopStepSequencer,
                exportPattern: exportPatternAsRegion,
                getPattern: getPatternData,
                updateCell: updateSequenceCell,  // [메모리 기반] 셀 상태 업데이트
                syncFromDOM: syncStateFromDOM    // [초기화용] DOM → 메모리 동기화
            };

            console.log('AURA Edit Dock Focus System loaded');
            console.log('AURA Step Sequencer ready (Space to play, Drag to Timeline)');
            // ============================================
            // [통합] Step Cell 이벤트 핸들러 (같은 IIFE 내에서 sequenceData 직접 접근)
            // ============================================
            const stepSeqGrid = document.querySelector('.step-seq-grid');
            if (stepSeqGrid) {
                // 좌클릭 - 활성화/비활성화 토글
                stepSeqGrid.addEventListener('click', function(e) {
                    const cell = e.target.closest('.step-cell');
                    if (!cell) return;

                    const row = cell.closest('.step-seq-row');
                    const track = row?.dataset.track;
                    const stepIndex = parseInt(cell.dataset.step);

                    if (!track || isNaN(stepIndex)) return;

                    // ⭐ Ghost 클래스 제거 (Ghost + Active 충돌 방지)
                    const wasGhost = cell.classList.contains('ghost');
                    if (wasGhost) {
                        cell.classList.remove('ghost');
                    }

                    // UI 토글 (Ghost였으면 무조건 Active로)
                    let isActive;
                    if (wasGhost) {
                        cell.classList.add('active');
                        isActive = true;
                    } else {
                        isActive = cell.classList.toggle('active');
                    }

                    // 비활성화 시 래칫 초기화
                    if (!isActive) {
                        cell.classList.remove('ratchet');
                        delete cell.dataset.ratchet;
                        const label = cell.querySelector('.ratchet-label');
                        if (label) label.remove();
                    }

                    // 메모리 동기화 (직접 접근!) - 없으면 새로 생성!
                    if (sequenceData[track]) {
                        if (!sequenceData[track][stepIndex]) {
                            sequenceData[track][stepIndex] = { active: false, ratchet: 0 };
                        }
                        sequenceData[track][stepIndex].active = isActive;
                        if (!isActive) sequenceData[track][stepIndex].ratchet = 0;
                    }

                    console.log(`[Click] ${track}:${stepIndex} = ${isActive}`);
                });

                // 우클릭 - 래칫 설정
                stepSeqGrid.addEventListener('contextmenu', function(e) {
                    const cell = e.target.closest('.step-cell');
                    if (!cell) return;

                    e.preventDefault();

                    // 활성화된 셀에서만 래칫 가능
                    if (!cell.classList.contains('active')) return;

                    const row = cell.closest('.step-seq-row');
                    const track = row?.dataset.track;
                    const stepIndex = parseInt(cell.dataset.step);

                    if (!track || isNaN(stepIndex)) return;

                    // 래칫 순환: 0 → 2 → 3 → 4 → 0
                    let currentRatchet = parseInt(cell.dataset.ratchet) || 0;
                    let newRatchet = currentRatchet === 0 ? 2 : currentRatchet + 1;
                    if (newRatchet > 4) newRatchet = 0;

                    // 기존 라벨 제거
                    const existingLabel = cell.querySelector('.ratchet-label');
                    if (existingLabel) existingLabel.remove();

                    // UI 업데이트
                    if (newRatchet >= 2) {
                        cell.classList.add('ratchet');
                        cell.dataset.ratchet = newRatchet;
                        const label = document.createElement('span');
                        label.className = 'ratchet-label';
                        label.textContent = 'x' + newRatchet;
                        cell.appendChild(label);
                    } else {
                        cell.classList.remove('ratchet');
                        delete cell.dataset.ratchet;
                    }

                    // 메모리 동기화 (직접 접근!) - 없으면 새로 생성!
                    if (sequenceData[track]) {
                        if (!sequenceData[track][stepIndex]) {
                            sequenceData[track][stepIndex] = { active: true, ratchet: 0 };
                        }
                        sequenceData[track][stepIndex].ratchet = newRatchet;
                    }

                    console.log(`[Ratchet] ${track}:${stepIndex} = x${newRatchet}`);
                });

                console.log('[Step Seq] Cell event handlers registered');
            }

            // 페이지 로드 시 DOM → 메모리 동기화 (초기 상태 반영)
            syncStateFromDOM();

            console.log('AURA Edit Dock Focus System loaded');
            console.log('AURA Step Sequencer ready (Space to play, Drag to Timeline)');
        })();

        // Track Header Panel Expand/Collapse Toggle (All tracks at once)
        function toggleAllTracksExpand() {
            const headersPanel = document.getElementById('trackHeadersPanel');
            if (headersPanel) {
                headersPanel.classList.toggle('expanded');
            }
        }

        // Track Button Toggle (M/S/R)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('track-btn')) {
                e.stopPropagation();
                e.target.classList.toggle('active');
            }
        });

        // Mixer Panel M/S Button Toggle
        document.querySelectorAll('.btn-mixer-ctrl').forEach(btn => {
            btn.addEventListener('click', function() {
                const isMute = this.textContent === 'M';
                const isSolo = this.textContent === 'S';

                if (isMute) {
                    this.classList.toggle('active-mute');
                } else if (isSolo) {
                    this.classList.toggle('active-solo');
                }
            });
        });

        // Smart Knob Drag Functionality
        (function() {
            let activeKnob = null;
            let startY = 0;
            let startRotation = 0;

            document.querySelectorAll('.smart-knob').forEach(knob => {
                knob.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    activeKnob = this;
                    startY = e.clientY;

                    // Get current rotation
                    const style = getComputedStyle(this);
                    const currentRotation = style.getPropertyValue('--knob-rotation') || '0deg';
                    startRotation = parseFloat(currentRotation);

                    this.classList.add('active');
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                });
            });

            document.addEventListener('mousemove', function(e) {
                if (!activeKnob) return;

                const deltaY = startY - e.clientY;
                let newRotation = startRotation + deltaY * 1.5;

                // Clamp between -135 and 135 degrees
                newRotation = Math.max(-135, Math.min(135, newRotation));

                activeKnob.style.setProperty('--knob-rotation', newRotation + 'deg');

                // Update value display
                const valueDisplay = activeKnob.querySelector('.smart-knob-value');
                if (valueDisplay) {
                    const percent = Math.round(((newRotation + 135) / 270) * 100);
                    valueDisplay.textContent = percent + '%';
                }
            });

            document.addEventListener('mouseup', function() {
                if (activeKnob) {
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    activeKnob = null;
                }
            });
        })();

        // Mixer Channel Selection
        document.querySelectorAll('.channel-strip').forEach(strip => {
            strip.addEventListener('click', function(e) {
                // M/S 버튼이나 페이더, 스마트노브 클릭은 제외
                if (e.target.classList.contains('btn-mixer-ctrl') ||
                    e.target.classList.contains('mixer-fader-thumb') ||
                    e.target.classList.contains('smart-knob') ||
                    e.target.classList.contains('smart-knob-indicator')) {
                    return;
                }

                // 다른 채널 선택 해제
                document.querySelectorAll('.channel-strip').forEach(s => {
                    s.classList.remove('selected');
                });

                // 현재 채널 선택
                this.classList.add('selected');
            });
        });

        // Mixer Fader Drag Functionality
        (function() {
            let activeFader = null;
            let faderTrack = null;
            let startY = 0;
            let startBottom = 0;

            document.querySelectorAll('.mixer-fader-thumb').forEach(thumb => {
                thumb.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    activeFader = this;
                    faderTrack = this.parentElement;
                    startY = e.clientY;
                    startBottom = parseFloat(this.style.bottom) || 50;

                    document.body.style.cursor = 'grabbing';
                    document.body.style.userSelect = 'none';
                    this.style.cursor = 'grabbing';
                });
            });

            document.addEventListener('mousemove', function(e) {
                if (!activeFader) return;

                const trackHeight = faderTrack.offsetHeight;
                const deltaY = startY - e.clientY;
                const deltaPercent = (deltaY / trackHeight) * 100;
                let newBottom = startBottom + deltaPercent;

                // Clamp between 0% and 90%
                newBottom = Math.max(0, Math.min(90, newBottom));

                activeFader.style.bottom = newBottom + '%';

                // Update volume display
                const channelStrip = activeFader.closest('.channel-strip');
                if (channelStrip) {
                    const volDisplay = channelStrip.querySelector('.mixer-vol-display');
                    if (volDisplay) {
                        // Convert position to dB (-inf to +6)
                        let db;
                        if (newBottom < 1) {
                            db = '-∞';
                        } else {
                            db = ((newBottom / 90) * 12 - 12 + 6).toFixed(1);
                        }
                        volDisplay.textContent = db === '-∞' ? db : db;
                    }

                    // Update level meters (simulate)
                    const levelMeters = channelStrip.querySelectorAll('.level-meter-fill');
                    levelMeters.forEach((meter, i) => {
                        const variation = (Math.random() * 5) - 2.5;
                        const height = Math.max(0, Math.min(100, newBottom + variation));
                        meter.style.height = height + '%';
                    });
                }
            });

            document.addEventListener('mouseup', function() {
                if (activeFader) {
                    activeFader.style.cursor = 'grab';
                    activeFader = null;
                    faderTrack = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();

        // Timeline Divider Resize Functionality
        (function() {
            const divider = document.getElementById('timelineDivider');
            const headersPanel = document.getElementById('trackHeadersPanel');

            if (!divider || !headersPanel) return;

            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            divider.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = headersPanel.offsetWidth;

                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                let newWidth = startWidth + deltaX;

                // Enforce min/max constraints
                const minWidth = 100;
                const maxWidth = 300;
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));

                headersPanel.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();

        // Time Ruler Generation - Dynamic bar/beat markers
        (function() {
            const rulerContent = document.getElementById('timeRulerContent');
            if (!rulerContent) return;

            const barWidth = 100;  // 100px per bar
            const beatWidth = 25;  // 25px per beat (4 beats per bar)
            const totalBars = 32;  // Generate 32 bars (enough for most views)

            function generateRuler() {
                rulerContent.innerHTML = '';

                for (let bar = 1; bar <= totalBars; bar++) {
                    const barX = (bar - 1) * barWidth;

                    // Bar number marker
                    const marker = document.createElement('span');
                    marker.className = 'bar-marker';
                    marker.style.left = (barX + 5) + 'px';
                    marker.textContent = bar;
                    rulerContent.appendChild(marker);

                    // Beat ticks for this bar
                    for (let beat = 0; beat < 4; beat++) {
                        const tick = document.createElement('div');
                        tick.className = 'beat-tick ' + (beat === 0 ? 'bar' : 'beat');
                        tick.style.left = (barX + beat * beatWidth) + 'px';
                        rulerContent.appendChild(tick);
                    }
                }
            }

            generateRuler();

            // Regenerate on window resize if needed
            window.addEventListener('resize', generateRuler);
        })();

        // Piano Roll Generation - Real Piano Layout
        (function() {
            const pianoKeys = document.getElementById('pianoKeys');
            const pianoRollRuler = document.getElementById('pianoRollRuler');
            const midiGridRows = document.getElementById('midiGridRows');
            const midiNotes = document.getElementById('midiNotes');
            const velocityGrid = document.getElementById('velocityGrid');

            if (!pianoKeys) return;

            // Grid rows still have same height for MIDI editing
            const rowHeight = 14;

            // Piano key visual heights
            const whiteKeyHeight = 20;  // White keys are taller visually
            const blackKeyHeight = 16;  // Black keys are shorter

            // Generate from B5 down to C2
            const startOctave = 5;
            const endOctave = 2;

            const keyPositions = [];
            // All 12 notes in descending order for grid rows
            const allNotes = ['B', 'A#', 'A', 'G#', 'G', 'F#', 'F', 'E', 'D#', 'D', 'C#', 'C'];
            const blackNotes = ['A#', 'G#', 'F#', 'D#', 'C#'];
            const whiteNotes = ['B', 'A', 'G', 'F', 'E', 'D', 'C'];

            let currentY = 0;

            // 1. Generate MIDI grid rows (all same height - for editing)
            for (let octave = startOctave; octave >= endOctave; octave--) {
                for (const noteName of allNotes) {
                    const fullName = noteName + octave;
                    const isBlack = blackNotes.includes(noteName);

                    const gridRow = document.createElement('div');
                    gridRow.className = 'midi-row ' + (isBlack ? 'black-key' : 'white-key');
                    if (noteName === 'C') gridRow.classList.add('c-row');
                    gridRow.style.top = currentY + 'px';
                    gridRow.style.height = rowHeight + 'px';
                    midiGridRows.appendChild(gridRow);

                    keyPositions.push({
                        note: fullName,
                        y: currentY,
                        height: rowHeight,
                        isWhite: !isBlack,
                        name: noteName
                    });

                    currentY += rowHeight;
                }
            }

            // 2. Generate piano keys (Real Piano Layout)
            // White keys: 7 per octave, placed sequentially
            // Black keys: 5 per octave, overlay between white keys

            const totalOctaves = startOctave - endOctave + 1;
            const totalWhiteKeys = totalOctaves * 7;
            const whiteKeyVisualHeight = (currentY) / totalWhiteKeys;  // Fit all white keys in the grid height

            let whiteKeyY = 0;

            // Generate white keys first (B, A, G, F, E, D, C per octave from top)
            for (let octave = startOctave; octave >= endOctave; octave--) {
                for (const noteName of whiteNotes) {
                    const fullName = noteName + octave;

                    const key = document.createElement('div');
                    key.className = 'piano-key-white';
                    if (noteName === 'C') {
                        key.classList.add('c-key');
                        key.textContent = fullName;
                    }
                    key.style.top = whiteKeyY + 'px';
                    key.style.height = whiteKeyVisualHeight + 'px';
                    pianoKeys.appendChild(key);

                    whiteKeyY += whiteKeyVisualHeight;
                }
            }

            // Generate black keys (overlay between white keys)
            // Black key positions relative to white keys in each octave:
            // A# between B-A, G# between A-G, F# between G-F, D# between E-D, C# between D-C
            const blackKeyPositions = [
                { name: 'A#', afterWhite: 0 },  // After B (index 0)
                { name: 'G#', afterWhite: 1 },  // After A (index 1)
                { name: 'F#', afterWhite: 2 },  // After G (index 2)
                { name: 'D#', afterWhite: 4 },  // After E (index 4)
                { name: 'C#', afterWhite: 5 }   // After D (index 5)
            ];

            for (let octave = startOctave; octave >= endOctave; octave--) {
                const octaveOffset = (startOctave - octave) * 7 * whiteKeyVisualHeight;

                for (const bk of blackKeyPositions) {
                    const fullName = bk.name + octave;
                    const blackKeyY = octaveOffset + (bk.afterWhite + 1) * whiteKeyVisualHeight - blackKeyHeight / 2;

                    const key = document.createElement('div');
                    key.className = 'piano-key-black';
                    key.style.top = blackKeyY + 'px';
                    key.style.height = blackKeyHeight + 'px';
                    pianoKeys.appendChild(key);
                }
            }

            // Generate Piano Roll Ruler - Cubase style "9 . 4" format
            const barWidth = 100;
            const beatWidth = 25;
            const totalBars = 16;
            const startBar = 9;

            for (let bar = startBar; bar <= startBar + totalBars; bar++) {
                const barX = (bar - startBar) * barWidth;

                // Bar number with beat format: "9 . 1"
                const marker = document.createElement('span');
                marker.className = 'piano-roll-bar-marker';
                marker.style.left = (barX + 4) + 'px';
                marker.innerHTML = bar + '<span class="bar-beat"> . 1</span>';
                pianoRollRuler.appendChild(marker);

                // Beat markers: ". 2", ". 3", ". 4"
                for (let beat = 1; beat < 4; beat++) {
                    const beatMarker = document.createElement('span');
                    beatMarker.className = 'piano-roll-beat-marker';
                    beatMarker.style.left = (barX + beat * beatWidth + 2) + 'px';
                    beatMarker.textContent = '. ' + (beat + 1);
                    pianoRollRuler.appendChild(beatMarker);
                }
            }

            // Demo MIDI Notes
            const demoNotes = [
                { note: 'C#3', x: 50, width: 60, velocity: 100 },
                { note: 'C3', x: 150, width: 75, velocity: 90 },
                { note: 'C#3', x: 325, width: 100, velocity: 95 },
                { note: 'G#2', x: 250, width: 50, velocity: 80 }
            ];

            demoNotes.forEach(noteData => {
                const keyInfo = keyPositions.find(k => k.note === noteData.note);
                if (!keyInfo) return;

                const noteEl = document.createElement('div');
                noteEl.className = 'midi-note';
                noteEl.style.left = noteData.x + 'px';
                noteEl.style.top = keyInfo.y + 'px';
                noteEl.style.width = noteData.width + 'px';
                noteEl.style.height = (keyInfo.height - 2) + 'px';
                noteEl.textContent = noteData.note;
                midiNotes.appendChild(noteEl);

                const velBar = document.createElement('div');
                velBar.className = 'velocity-bar';
                velBar.style.left = (noteData.x + noteData.width / 2 - 4) + 'px';
                velBar.style.height = (noteData.velocity * 0.4) + 'px';
                velocityGrid.appendChild(velBar);
            });

        })();

        // ============================================
        // AURA Transport Control - Tone.js 연동
        // ============================================
        (function() {
            const playBtn = document.querySelector('.play-btn');
            const stopBtn = document.querySelector('.stop-btn');
            const bpmDisplay = document.querySelector('.bpm-value');
            const playhead = document.querySelector('.playhead');
            const pianoRollPlayhead = document.querySelector('.piano-roll-playhead');

            let isPlaying = false;
            let isInitialized = false;
            let animationFrameId = null;
            let playStartPosition = '0:0:0'; // 재생 시작 위치 저장
            const BAR_WIDTH = 100; // 100px per bar

            // Tone.js 초기화 (첫 클릭 시)
            async function initAudio() {
                if (isInitialized) return true;
                try {
                    await Tone.start();
                    Tone.Transport.bpm.value = 120; // 초기 BPM
                    isInitialized = true;
                    console.log('AURA Audio Engine initialized');
                    return true;
                } catch (e) {
                    console.error('Audio init failed:', e);
                    return false;
                }
            }

            // Playhead 애니메이션 - 마디:박자 기반
            // 그리드: 1 Bar = 100px, 1 Beat = 25px
            const BEAT_WIDTH = 25;

            function positionToPixel(positionStr) {
                // Tone.js position format: "Bar:Beat:Sixteenth"
                const parts = positionStr.toString().split(':').map(Number);
                const bar = parts[0] || 0;
                const beat = parts[1] || 0;
                const sixteenth = parts[2] || 0;

                return (bar * BAR_WIDTH) + (beat * BEAT_WIDTH) + (sixteenth * BEAT_WIDTH / 4);
            }

            function updatePlayhead() {
                if (!isPlaying) return;

                // Tone.js Transport position (마디:박자:16분음표)
                const position = Tone.Transport.position;
                const pixelX = positionToPixel(position);

                // Timeline playhead (트랙뷰 그리드 기준)
                if (playhead) {
                    playhead.style.left = pixelX + 'px';
                }

                // Piano roll playhead
                if (pianoRollPlayhead) {
                    pianoRollPlayhead.style.left = pixelX + 'px';
                }

                animationFrameId = requestAnimationFrame(updatePlayhead);
            }

            // Play
            function play() {
                if (isPlaying) return;
                isPlaying = true;
                playBtn.classList.add('playing');

                // 현재 위치를 재생 시작 위치로 저장
                playStartPosition = Tone.Transport.position.toString();

                Tone.Transport.start();
                updatePlayhead();
                console.log('Transport started at:', playStartPosition);
            }

            // Stop - 재생 시작 위치로 돌아감
            function stop() {
                isPlaying = false;
                playBtn.classList.remove('playing');
                Tone.Transport.stop();

                // 재생 시작 위치로 돌아감 (곡 처음이 아님)
                Tone.Transport.position = playStartPosition;

                // Playhead도 시작 위치로 이동
                const startPixel = positionToPixel(playStartPosition);
                if (playhead) playhead.style.left = startPixel + 'px';
                if (pianoRollPlayhead) pianoRollPlayhead.style.left = startPixel + 'px';

                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }

                // Stop 버튼 눌림 효과 (150ms)
                stopBtn.classList.add('pressed');
                setTimeout(() => stopBtn.classList.remove('pressed'), 150);

                console.log('Transport stopped, returned to:', playStartPosition);
            }

            // Play 버튼 클릭
            playBtn.addEventListener('click', async function() {
                const ok = await initAudio();
                if (!ok) return;

                if (isPlaying) {
                    stop();
                } else {
                    play();
                }
            });

            // Stop 버튼 클릭
            stopBtn.addEventListener('click', async function() {
                const ok = await initAudio();
                if (!ok) return;
                stop();
            });

            // 키보드 단축키 (Space = Play/Stop)
            document.addEventListener('keydown', async function(e) {
                if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    const ok = await initAudio();
                    if (!ok) return;

                    if (isPlaying) {
                        stop();
                    } else {
                        play();
                    }
                }
            });

            // Record 버튼 토글
            const recBtn = document.querySelector('.rec-btn');
            let isRecording = false;

            function setRecording(value) {
                isRecording = value;
                if (isRecording) {
                    recBtn.classList.add('recording');
                    console.log('Recording ON');
                } else {
                    recBtn.classList.remove('recording');
                    console.log('Recording OFF');
                }
            }

            recBtn.addEventListener('click', function() {
                setRecording(!isRecording);
            });

            // Stop 시 Recording도 OFF
            const originalStop = stop;
            stop = function() {
                originalStop();
                if (isRecording) {
                    setRecording(false);
                }
            };

            console.log('AURA Transport Control loaded');
        })();

        // ============================================
        // BPM Control - 화살표 조정 + 더블클릭 입력
        // ============================================
        (function() {
            const bpmValue = document.getElementById('bpmValue');
            const bpmUp = document.getElementById('bpmUp');
            const bpmDown = document.getElementById('bpmDown');
            let currentBpm = 120;

            function updateBpmDisplay() {
                bpmValue.textContent = currentBpm.toFixed(3);
            }

            function setBpm(newBpm) {
                currentBpm = Math.max(20, Math.min(300, newBpm));
                updateBpmDisplay();

                // Tone.js Transport BPM 동기화
                if (typeof Tone !== 'undefined' && Tone.Transport) {
                    Tone.Transport.bpm.value = currentBpm;
                }
                console.log('BPM:', currentBpm);
            }

            // 길게 누르기 지원을 위한 변수
            let holdInterval = null;
            let holdTimeout = null;
            let holdSpeed = 100;  // 반복 간격 (ms)

            function startHold(direction) {
                // 먼저 한 번 실행
                setBpm(currentBpm + direction);

                // 300ms 후 반복 시작
                holdTimeout = setTimeout(() => {
                    holdSpeed = 100;  // 초기 속도
                    holdInterval = setInterval(() => {
                        setBpm(currentBpm + direction);
                        // 점점 빨라지기 (최소 30ms까지)
                        if (holdSpeed > 30) {
                            holdSpeed -= 5;
                            clearInterval(holdInterval);
                            holdInterval = setInterval(() => {
                                setBpm(currentBpm + direction);
                            }, holdSpeed);
                        }
                    }, holdSpeed);
                }, 300);
            }

            function stopHold() {
                if (holdTimeout) {
                    clearTimeout(holdTimeout);
                    holdTimeout = null;
                }
                if (holdInterval) {
                    clearInterval(holdInterval);
                    holdInterval = null;
                }
                holdSpeed = 100;
            }

            // 위 화살표 - BPM +1 (길게 누르면 연속 증가)
            bpmUp.addEventListener('mousedown', function(e) {
                e.preventDefault();
                startHold(1);
            });
            bpmUp.addEventListener('mouseup', stopHold);
            bpmUp.addEventListener('mouseleave', stopHold);

            // 아래 화살표 - BPM -1 (길게 누르면 연속 감소)
            bpmDown.addEventListener('mousedown', function(e) {
                e.preventDefault();
                startHold(-1);
            });
            bpmDown.addEventListener('mouseup', stopHold);
            bpmDown.addEventListener('mouseleave', stopHold);

            // 더블클릭 - 직접 입력
            bpmValue.addEventListener('dblclick', function() {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'bpm-input';
                input.value = currentBpm.toFixed(3);
                input.min = 20;
                input.max = 300;
                input.step = 0.001;

                // span을 input으로 교체
                this.style.display = 'none';
                this.parentNode.insertBefore(input, this);
                input.focus();
                input.select();

                function commitValue() {
                    const newBpm = parseFloat(input.value);
                    if (!isNaN(newBpm)) {
                        setBpm(newBpm);
                    }
                    input.remove();
                    bpmValue.style.display = '';
                }

                input.addEventListener('blur', commitValue);
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        commitValue();
                    } else if (e.key === 'Escape') {
                        input.remove();
                        bpmValue.style.display = '';
                    }
                });
            });

            // 마우스 휠로 BPM 조정
            bpmValue.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY < 0 ? 1 : -1;
                setBpm(currentBpm + delta);
            });

            updateBpmDisplay();
        })();

        // ============================================
        // Playhead Seek - 클릭으로 재생 위치 이동
        // 그리드 기준: 1 Bar = 100px, 1 Beat = 25px
        // ============================================
        (function() {
            const trackContentList = document.querySelector('.track-content-list');
            const timeRulerContent = document.getElementById('timeRulerContent');
            const playhead = document.querySelector('.playhead');
            const pianoRollPlayhead = document.querySelector('.piano-roll-playhead');

            // 그리드 상수
            const BAR_WIDTH = 100;   // 1마디 = 100px
            const BEAT_WIDTH = 25;   // 1박자 = 25px (4박자/마디)
            const BEATS_PER_BAR = 4;

            // 픽셀 위치를 마디:박자:16분음표 포맷으로 변환
            function pixelToPosition(pixelX) {
                if (pixelX < 0) pixelX = 0;

                // 마디 계산 (0-based)
                const bar = Math.floor(pixelX / BAR_WIDTH);

                // 마디 내 나머지 픽셀
                const remainingPixels = pixelX % BAR_WIDTH;

                // 박자 계산 (0-based)
                const beat = Math.floor(remainingPixels / BEAT_WIDTH);

                // 16분음표 계산 (박자 내 나머지)
                const beatRemainder = remainingPixels % BEAT_WIDTH;
                const sixteenth = Math.floor(beatRemainder / (BEAT_WIDTH / 4));

                // Tone.js 포맷: "Bar:Beat:Sixteenth" (0-based)
                return `${bar}:${beat}:${sixteenth}`;
            }

            // 마디:박자 포맷을 픽셀로 변환
            function positionToPixel(position) {
                const parts = position.split(':').map(Number);
                const bar = parts[0] || 0;
                const beat = parts[1] || 0;
                const sixteenth = parts[2] || 0;

                return (bar * BAR_WIDTH) + (beat * BEAT_WIDTH) + (sixteenth * BEAT_WIDTH / 4);
            }

            // Playhead를 특정 픽셀 위치로 이동
            function setPlayheadPixel(pixelX) {
                if (playhead) {
                    playhead.style.left = pixelX + 'px';
                }
                if (pianoRollPlayhead) {
                    pianoRollPlayhead.style.left = pixelX + 'px';
                }
            }

            // Seek 실행
            function seekToPosition(e, container) {
                const rect = container.getBoundingClientRect();

                // 스크롤 오프셋 고려 (컨테이너가 스크롤된 경우)
                const scrollLeft = container.scrollLeft || 0;
                const clickX = e.clientX - rect.left + scrollLeft;

                // 음수 방지
                const pixelX = Math.max(0, clickX);

                // 픽셀 → 마디:박자:16분음표
                const position = pixelToPosition(pixelX);

                // Tone.js Transport 위치 설정
                if (typeof Tone !== 'undefined' && Tone.Transport) {
                    Tone.Transport.position = position;
                }

                // Playhead 즉시 이동 (트랙뷰 기준)
                setPlayheadPixel(pixelX);

                // 디버그 로그
                const parts = position.split(':');
                console.log(`Seek to: Bar ${parseInt(parts[0]) + 1}, Beat ${parseInt(parts[1]) + 1} (${position}) | clickX=${clickX.toFixed(0)}px`);
            }

            // Track Content List 클릭 (빈 공간 클릭)
            if (trackContentList) {
                trackContentList.addEventListener('click', function(e) {
                    // 리전/클립 클릭은 무시 (빈 공간만 처리)
                    if (e.target.closest('.track-region, .chord-block')) {
                        return;
                    }
                    seekToPosition(e, this);
                });
            }

            // Time Ruler 클릭
            if (timeRulerContent) {
                timeRulerContent.addEventListener('click', function(e) {
                    seekToPosition(e, this);
                });
            }

            console.log('AURA Playhead Seek loaded (Grid: 100px/bar, 25px/beat)');
        })();

        // ============================================
        // Metronome Control
        // ============================================
        (function() {
            const metronomeBtn = document.getElementById('metronomeBtn');
            if (!metronomeBtn) return;

            let isMetronomeOn = false;
            let metronomeScheduleId = null;
            let clickSynth = null;  // 재사용할 synth

            // 메트로놈 synth 초기화 - 표준 메트로놈 클릭 사운드
            let accentSynth = null;
            let normalSynth = null;

            function initMetronomeSynth() {
                if (typeof Tone === 'undefined') return;
                if (accentSynth) return;

                // 악센트용 (첫 박) - 높고 날카로운 우드블록 사운드
                accentSynth = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.03,
                        sustain: 0,
                        release: 0.01
                    }
                }).toDestination();
                accentSynth.volume.value = -8;

                // 일반 박자용 - 약간 낮은 클릭
                normalSynth = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.025,
                        sustain: 0,
                        release: 0.01
                    }
                }).toDestination();
                normalSynth.volume.value = -10;

                clickSynth = { accent: accentSynth, normal: normalSynth };
            }

            // 펜듈럼 요소
            const pendulumGroup = metronomeBtn.querySelector('.metro-pendulum-group');
            let pendulumDirection = 1;  // 1: 오른쪽, -1: 왼쪽

            // 펜듈럼 스윙 (BPM 동기화)
            function swingPendulum() {
                if (!pendulumGroup || !isMetronomeOn) return;
                pendulumDirection *= -1;
                const angle = pendulumDirection * 18;
                pendulumGroup.style.transform = `rotate(${angle}deg)`;
            }

            // 펜듈럼 리셋
            function resetPendulum() {
                if (pendulumGroup) {
                    pendulumGroup.style.transform = 'rotate(0deg)';
                }
                pendulumDirection = 1;
            }

            // 메트로놈 토글
            function toggleMetronome() {
                isMetronomeOn = !isMetronomeOn;
                metronomeBtn.classList.toggle('active', isMetronomeOn);

                if (isMetronomeOn) {
                    console.log('Metronome ON');
                    initMetronomeSynth();
                    scheduleMetronome();
                } else {
                    console.log('Metronome OFF');
                    cancelMetronome();
                    resetPendulum();
                }
            }

            // 메트로놈 취소
            function cancelMetronome() {
                if (metronomeScheduleId !== null && typeof Tone !== 'undefined') {
                    Tone.Transport.clear(metronomeScheduleId);
                    metronomeScheduleId = null;
                }
            }

            // 메트로놈 스케줄링 - Tone.js time 파라미터 사용으로 정확한 타이밍
            function scheduleMetronome() {
                if (!isMetronomeOn) return;
                if (typeof Tone === 'undefined' || !Tone.Transport) return;

                // 기존 스케줄 제거
                cancelMetronome();

                // 매 비트마다 클릭 (4분음표) - 시작 시간을 0으로 지정
                metronomeScheduleId = Tone.Transport.scheduleRepeat((time) => {
                    if (!isMetronomeOn || !clickSynth) return;

                    // 현재 Transport 위치에서 비트 계산
                    const position = Tone.Transport.position.toString();
                    const parts = position.split(':');
                    const beat = parseInt(parts[1]) || 0;
                    const isAccent = beat === 0;

                    if (isAccent) {
                        accentSynth.triggerAttackRelease('G6', '64n', time);
                    } else {
                        normalSynth.triggerAttackRelease('C6', '64n', time);
                    }

                    // 펜듈럼 스윙 (메인 스레드에서 실행)
                    Tone.Draw.schedule(() => {
                        swingPendulum();
                    }, time);
                }, '4n', 0);  // 세 번째 인자: 시작 시간 0 (처음부터)
            }

            metronomeBtn.addEventListener('click', toggleMetronome);

            // 키보드 단축키 (M)
            document.addEventListener('keydown', function(e) {
                if (e.target.matches('input, textarea')) return;
                if (e.code === 'KeyM' && !e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    toggleMetronome();
                }
            });

            console.log('AURA Metronome loaded');
        })();

        // ============================================
        // Timeline Toolbar (Select/Split/Draw/Eraser)
        // ============================================
        (function() {
            const toolbar = document.getElementById('timelineToolbar');
            if (!toolbar) return;

            const toolBtns = toolbar.querySelectorAll('.tool-btn');
            let currentTool = 'select';

            function setActiveTool(tool) {
                currentTool = tool;

                // 버튼 활성화 상태 업데이트
                toolBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tool === tool);
                });

                // 커서 변경
                const trackContent = document.querySelector('.track-content-list');
                if (trackContent) {
                    switch (tool) {
                        case 'select':
                            trackContent.style.cursor = 'default';
                            break;
                        case 'split':
                            trackContent.style.cursor = 'crosshair';
                            break;
                        case 'draw':
                            trackContent.style.cursor = 'crosshair';
                            break;
                        case 'eraser':
                            trackContent.style.cursor = 'not-allowed';
                            break;
                    }
                }

                console.log('Tool selected:', tool);
            }

            // 버튼 클릭 이벤트
            toolBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    setActiveTool(this.dataset.tool);
                });
            });

            // 키보드 단축키 (1, 2, 3, 4)
            document.addEventListener('keydown', function(e) {
                if (e.target.matches('input, textarea')) return;

                switch (e.code) {
                    case 'Digit1':
                        setActiveTool('select');
                        break;
                    case 'Digit2':
                        setActiveTool('split');
                        break;
                    case 'Digit3':
                        setActiveTool('draw');
                        break;
                    case 'Digit4':
                        setActiveTool('eraser');
                        break;
                }
            });

            console.log('AURA Timeline Toolbar loaded');
        })();

        // ============================================
        // Smart Kit Morph - Context-Aware Heuristic Logic
        // ============================================
        (function() {
            // Neon 색상 팔레트 (랜덤 선택용)
            const MORPH_COLORS = [
                '#4DFFFF',  // Cyan (default)
                '#FF6BFF',  // Magenta
                '#6BFF6B',  // Green
                '#FFD700',  // Gold
                '#FF6B6B',  // Coral
                '#9B6BFF',  // Purple
                '#FF9B6B',  // Orange
                '#6BFFFF',  // Aqua
            ];

            // 장르별 드럼 프리셋
            const GENRE_PRESETS = {
                hiphop: {
                    name: 'Hip-Hop',
                    kick: { pitchDecay: 0.08, octaves: 8, attack: 0.001, decay: 0.5 },
                    snare: { noise: 'white', attack: 0.005, decay: 0.2 },
                    hihat: { frequency: 200, decay: 0.08 },
                    perc: { pitchDecay: 0.02, octaves: 3, decay: 0.15 }
                },
                pop: {
                    name: 'Pop',
                    kick: { pitchDecay: 0.05, octaves: 6, attack: 0.001, decay: 0.4 },
                    snare: { noise: 'white', attack: 0.001, decay: 0.15 },
                    hihat: { frequency: 250, decay: 0.05 },
                    perc: { pitchDecay: 0.01, octaves: 4, decay: 0.1 }
                },
                house: {
                    name: 'House',
                    kick: { pitchDecay: 0.03, octaves: 10, attack: 0.001, decay: 0.3 },
                    snare: { noise: 'pink', attack: 0.001, decay: 0.12 },
                    hihat: { frequency: 300, decay: 0.03 },
                    perc: { pitchDecay: 0.005, octaves: 5, decay: 0.08 }
                },
                trap: {
                    name: 'Trap',
                    kick: { pitchDecay: 0.1, octaves: 12, attack: 0.001, decay: 0.6 },
                    snare: { noise: 'white', attack: 0.001, decay: 0.25 },
                    hihat: { frequency: 350, decay: 0.02 },
                    perc: { pitchDecay: 0.015, octaves: 6, decay: 0.2 }
                }
            };

            /**
             * getPatternStats() - 현재 패턴 분석
             * @returns {Object} { bpm, density, activeNotes, genre }
             */
            function getPatternStats() {
                const bpm = Tone?.Transport?.bpm?.value || 120;

                // 패턴 데이터 가져오기
                const pattern = window.stepSeqState?.getPattern?.() || {
                    kick: [], snare: [], hihat: [], perc: []
                };

                // 활성 노트 수 계산
                let activeNotes = 0;
                let totalSteps = 0;

                ['kick', 'snare', 'hihat', 'perc'].forEach(track => {
                    const steps = pattern[track] || [];
                    steps.forEach(step => {
                        totalSteps++;
                        if (step && step.active) {
                            activeNotes++;
                            // 래칫은 추가 노트로 계산
                            if (step.ratchet >= 2) {
                                activeNotes += (step.ratchet - 1);
                            }
                        }
                    });
                });

                // 밀도 계산 (0~1)
                const density = totalSteps > 0 ? activeNotes / totalSteps : 0;

                // BPM 기반 장르 추정
                let genre = 'pop';  // default
                if (bpm < 90) {
                    genre = 'hiphop';
                } else if (bpm >= 90 && bpm < 120) {
                    genre = 'pop';
                } else if (bpm >= 120 && bpm < 140) {
                    // 밀도가 높으면 Trap, 낮으면 House
                    genre = density > 0.3 ? 'trap' : 'house';
                } else {
                    genre = 'trap';
                }

                return {
                    bpm,
                    density,
                    activeNotes,
                    totalSteps,
                    genre
                };
            }

            /**
             * randomize() - 값에 랜덤 변화 적용
             * @param {number} base - 기본값
             * @param {number} variance - 변화 범위 (0~1)
             * @returns {number}
             */
            function randomize(base, variance = 0.2) {
                const multiplier = 1 + (Math.random() - 0.5) * 2 * variance;
                return base * multiplier;
            }

            /**
             * applyPresetToSynths() - 프리셋을 신스에 즉시 적용
             * DOM 접근 없음 - 순수 Tone.js API 호출만
             */
            function applyPresetToSynths(preset) {
                const synths = window.auraDrumSynths;
                if (!synths) {
                    console.warn('[Kit Morph] Drum synths not initialized');
                    return false;
                }

                try {
                    // Kick 파라미터 적용
                    if (synths.kick && preset.kick) {
                        synths.kick.pitchDecay = randomize(preset.kick.pitchDecay, 0.15);
                        synths.kick.octaves = randomize(preset.kick.octaves, 0.1);
                        synths.kick.envelope.decay = randomize(preset.kick.decay, 0.15);
                    }

                    // Snare 파라미터 적용
                    if (synths.snare && preset.snare) {
                        synths.snare.envelope.decay = randomize(preset.snare.decay, 0.15);
                        synths.snare.envelope.release = randomize(preset.snare.release, 0.15);
                    }

                    // HiHat 파라미터 적용
                    if (synths.hihat && preset.hihat) {
                        synths.hihat.frequency = randomize(preset.hihat.frequency, 0.2);
                        synths.hihat.envelope.decay = randomize(preset.hihat.decay, 0.2);
                    }

                    // Perc 파라미터 적용
                    if (synths.perc && preset.perc) {
                        synths.perc.pitchDecay = randomize(preset.perc.pitchDecay, 0.15);
                        synths.perc.octaves = randomize(preset.perc.octaves, 0.1);
                        synths.perc.envelope.decay = randomize(preset.perc.decay, 0.15);
                    }

                    return true;
                } catch (e) {
                    console.error('[Kit Morph] Error applying preset:', e);
                    return false;
                }
            }

            /**
             * kitMorph() - Smart Kit Morph 실행
             * 패턴 분석 → 장르 감지 → 사운드 파라미터 즉시 적용
             */
            function kitMorph() {
                const stats = getPatternStats();
                const preset = GENRE_PRESETS[stats.genre] || GENRE_PRESETS.pop;

                console.log(`[Kit Morph] Genre: ${preset.name}, BPM: ${stats.bpm}, Density: ${(stats.density * 100).toFixed(1)}%`);

                // 사운드 파라미터 즉시 적용 (DOM 접근 없음)
                const applied = applyPresetToSynths(preset);

                return {
                    genre: stats.genre,
                    preset: preset.name,
                    stats,
                    applied
                };
            }

            /**
             * Kit Morph 버튼 클릭 핸들러
             */
            function handleKitMorphClick() {
                const btn = document.querySelector('.kit-morph-btn');
                if (!btn) return;

                // 애니메이션 시작
                btn.classList.add('morphing');

                // 랜덤 색상 선택
                const randomColor = MORPH_COLORS[Math.floor(Math.random() * MORPH_COLORS.length)];
                btn.style.setProperty('--morph-color', randomColor);

                // Kit Morph 실행
                const result = kitMorph();
                console.log(`[Kit Morph] Applied: ${result.preset}`);

                // 애니메이션 종료
                setTimeout(() => {
                    btn.classList.remove('morphing');
                }, 500);
            }

            // 이벤트 바인딩
            const morphBtn = document.querySelector('.kit-morph-btn');
            if (morphBtn) {
                morphBtn.addEventListener('click', handleKitMorphClick);
            }

            // 전역 접근 (API)
            window.SmartInstrumentAPI = {
                kitMorph,
                getPatternStats,
                applyPresetToSynths,
                GENRE_PRESETS,
                MORPH_COLORS
            };

            console.log('AURA Smart Kit Morph loaded');
        })();
    </script>
</body>
</html>
